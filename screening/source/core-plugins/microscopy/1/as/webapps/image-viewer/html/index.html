<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Image Viewer</title>

  <script src="jquery.js"></script>
  <script src="openbis.js"></script>
  <script src="openbis-screening.js"></script>

</head>
<body>
    <script>

    $(document).ready(function(){
    	var facade = new OpenbisFacade(new openbis());
    	
    	facade.login("admin", "password", function(response){
            var context = {
                    getSessionId : function(){
                        return response.result;
                    },
                    getEntityPermId : function(){
                        return "20140415140347875-53"
                    }
                };
			var widget = new ImageViewerWidget(context, facade);
			$("body").append(widget.render());				
    	});
    });
    
    //
    // FACADE
    //
    function OpenbisFacade(openbis){
    	this.init(openbis);
    }
    
    $.extend(OpenbisFacade.prototype, {
        init: function(openbis){
        	this.openbis = openbis;
        },
        
        login: function(user, password, callback){
        	this.openbis.login(user, password, callback);
        },

        getImageInfo: function(dataSetCode, callback){
	        this.openbis.getImageInfo(dataSetCode, null, callback);
        },
        
        getImageResolutions: function(dataSetCode, callback){
        	this.openbis.getImageResolutions(dataSetCode, callback);
        }
    });

    //
    // IMAGE VIEWER
    //
	function ImageViewerWidget(context, facade) {
	    this.init(context, facade);
	}
	
	$.extend(ImageViewerWidget.prototype, {
	    init: function(context, facade){
	    	this.context = context;
	    	this.facade = facade;
	    	this.panel = $("<div>")
	    },
	    
	    load: function(callback){
	    	if(this.loaded){
	    		callback();
	    	}else{
                var thisImageViewer = this;
                
                var manager = new CallbackManager(function(){
                    thisImageViewer.loaded = true;  
                    callback();
                });
                
                this.facade.getImageInfo(thisImageViewer.context.getEntityPermId(), manager.registerCallback(function(response){
                    thisImageViewer.imageInfo = response.result;
                }));
                
                this.facade.getImageResolutions(thisImageViewer.context.getEntityPermId(), manager.registerCallback(function(response){
                    thisImageViewer.imageResolutions = response.result;
                }));
	    	}
	    },
	    
	    render: function(){
	    	var thisImageViewer = this;
            
            this.load(function(){
            	
                var channelWidget = new ChannelChooserWidget(thisImageViewer.getChannels());
                channelWidget.setSelectedChannel("RGB");
                channelWidget.addChangeListener(function(){
                	imageWidget.setChannels(channelWidget.getSelectedOrMergedChannels());
                });
                thisImageViewer.panel.append(channelWidget.render());

                var resolutionWidget = new ResolutionChooserWidget(thisImageViewer.getResolutions());
                resolutionWidget.setSelectedResolution("512x512");
                resolutionWidget.addChangeListener(function(){
                	imageWidget.setResolution(resolutionWidget.getSelectedResolution());
                });
                thisImageViewer.panel.append(resolutionWidget.render());
                
                var channelStackWidget = new ChannelStackChooserWidget(thisImageViewer.getChannelStacks());
                channelStackWidget.setSelectedChannelStack(thisImageViewer.getChannelStacks()[0].id);
                channelStackWidget.addChangeListener(function(){
                    imageWidget.setChannelStackId(channelStackWidget.getSelectedChannelStack());
                });
                thisImageViewer.panel.append(channelStackWidget.render());
                
                var imageWidget = new ImageWidget();
                imageWidget.setDataStoreUrl("http://localhost:8889/datastore_server_screening");
                imageWidget.setSessionToken(thisImageViewer.context.getSessionId());
                imageWidget.setDataSetCode(thisImageViewer.context.getEntityPermId());
                imageWidget.setChannelStackId(channelStackWidget.getSelectedChannelStack());
                imageWidget.setResolution(resolutionWidget.getSelectedResolution());
                imageWidget.setChannels(channelWidget.getSelectedOrMergedChannels());
                
                thisImageViewer.panel.append(imageWidget.render());

            });
	    	
	    	return this.panel;
	    },
	    
	    getChannels: function(){
	    	//return this.imageInfo.imageDataset.imageDataset.imageParameters.channels;
	    	return [
	    	        {
	    	        	  code: "RGB",
	    	        	  label: "RGB label"
	    	        },
                    {
                        code: "CMYK",
                        label: "CMYK label"
                    }
	    	        ];
	    },
	    
	    getChannelStacks: function(){
	    	return this.imageInfo.channelStacks;
        },
        
        getResolutions: function(){
            return this.imageResolutions;
        }
	    
	});
	
    //
    // CHANNEL CHOOSER
    //
    function ChannelChooserWidget(channels) {
        this.init(channels);
    }
    
    $.extend(ChannelChooserWidget.prototype, {

        init: function(channels){
        	this.channels = channels;
        	this.selectedChannel = null;
        	this.mergedChannels = channels.map(function(channel){
                return channel.code;
            });
        	
        	this.listeners = new ListenerManager();
        	this.panel = $("<div>");
        },
        
        render: function(){
        	var thisChooser = this; 
            
            var select = $("<select>").appendTo(this.panel);
            
            $("<option>").attr("value", "").text("Merged Channels").appendTo(select);
            
            this.channels.forEach(function(channel){
            	$("<option>").attr("value", channel.code).text(channel.label).appendTo(select);
            });
            
            select.change(function(){
                if(select.val() == ""){
                    thisChooser.setSelectedChannel(null);                    
                }else{
                    thisChooser.setSelectedChannel(select.val());
                }
            });

            var mergedChannels = $("<div>").addClass("mergedChannels").appendTo(this.panel);
            
            this.channels.forEach(function(channel){
	            var mergedChannel = $("<span>").addClass("mergedChannel").appendTo(mergedChannels);
	            $("<input>").attr("type", "checkbox").attr("value", channel.code).appendTo(mergedChannel);
	            mergedChannel.append(channel.label);
            });

            mergedChannels.find("input").change(function(){
            	var channels = []
            	mergedChannels.find("input:checked").each(function(){
            		var checkbox = $(this);
            		channels.push(checkbox.val());
            	});
            	thisChooser.setMergedChannels(channels);
            });

            this.rendered = true;
            this.refresh();
            
            return this.panel;
        },
        
        refresh: function(){
        	if(!this.rendered){
        		return;
        	}
        	
        	var thisChooser = this;
        	
        	var select = this.panel.find("select");
        	var mergedChannels = this.panel.find(".mergedChannels");
        	
        	if(this.getSelectedChannel()){
                select.val(this.getSelectedChannel());
                mergedChannels.hide();
        	}else{
                select.val("");
                mergedChannels.find("input").each(function(){
                    var checkbox = $(this);
                    checkbox.prop("checked", $.inArray(checkbox.val(), thisChooser.getMergedChannels()) != -1);
                });
                mergedChannels.show();
        	}
        },

        getSelectedChannel: function(){
            return this.selectedChannel;
        },
        
        setSelectedChannel: function(channel){
            this.selectedChannel = channel;
            this.refresh();
            this.notifyChangeListeners();
        },
        
        getMergedChannels: function(){
        	return this.mergedChannels;
        },
        
        setMergedChannels: function(channels){
            this.mergedChannels = channels;
            this.refresh();
            this.notifyChangeListeners();
        },
        
        getSelectedOrMergedChannels: function(){
            if(this.getSelectedChannel()){
            	return [this.getSelectedChannel()];
            }else{
            	return this.getMergedChannels();
            }
        },
        
        addChangeListener: function(listener){
        	this.listeners.addListener('change', listener);
        },
        
        notifyChangeListeners: function(){
        	this.listeners.notifyListeners('change');
        }
        
    });
    
    //
    // RESOLUTION CHOOSER
    //
    function ResolutionChooserWidget(resolutions) {
        this.init(resolutions);
    }
    
    $.extend(ResolutionChooserWidget.prototype, {

    	 init: function(resolutions){
             this.resolutions = resolutions;
             this.listeners = new ListenerManager();
             this.panel = $("<div>");
         },
         
         render: function(){
             var thisChooser = this; 
             
             var select = $("<select>").appendTo(this.panel);
             
             $("<option>").attr("value", "").text("Default").appendTo(select);
             
             this.resolutions.forEach(function(resolution){
            	 var value = resolution.width + "x" + resolution.height;
                 $("<option>").attr("value", value).text(value).appendTo(select);
             });

             select.change(function(){
                 thisChooser.setSelectedResolution(select.val());
             });
             
             this.rendered = true;
             this.refresh();

             return this.panel;
         },

         refresh: function(){
        	 if(!this.rendered){
        		 return;
        	 }
        	 
        	 var select = this.panel.find("select");
        	 if(this.selectedResolution){
        		 select.val(this.selectedResolution);
        	 }
         },
         
         getSelectedResolution: function(){
             return this.selectedResolution;
         },
         
         setSelectedResolution: function(resolution){
             this.selectedResolution = resolution;
             this.refresh();
             this.notifyChangeListeners();
         },
         
         addChangeListener: function(listener){
             this.listeners.addListener('change', listener);
         },
         
         notifyChangeListeners: function(){
             this.listeners.notifyListeners('change');
         }

    });
    
    //
    // CHANNEL STACK CHOOSER
    //
    function ChannelStackChooserWidget(channelStacks) {
        this.init(channelStacks);
    }
    
    $.extend(ChannelStackChooserWidget.prototype, {

         init: function(channelStacks){
             this.channelStackManager = new ChannelStackManager(channelStacks);
             this.selectedChannelStack = null;
             this.listeners = new ListenerManager();
             this.panel = $("<div>");
         },
         
         render: function(){
        	 /*
        	  var thisChooser = this; 
              
              var select = $("<select>").appendTo(this.panel);
              
              this.channelStacks.forEach(function(channelStack){
            	  var value = channelStack.id;
            	  var text = "T: " + channelStack.timePointOrNull + ", D: " + channelStack.depthOrNull;
                  $("<option>").attr("value", value).text(text).appendTo(select);
              });

              select.change(function(){
                  thisChooser.setSelectedChannelStack(select.val());
              });
              
              this.rendered = true;
              this.refresh();
              */
              
              console.log("series present: " + this.channelStackManager.isSeriesNumberPresent());
              console.log("timepoint missing: " + this.channelStackManager.isTimePointMissing());
              console.log("depth missing: " + this.channelStackManager.isDepthMissing());
              console.log("depth consistent: " + this.channelStackManager.isDepthConsistent());
              console.log("time points: " + this.channelStackManager.getTimePoints());
              console.log("depths: " + this.channelStackManager.getDepths());
              
              return this.panel;
         },
         
         refresh: function(){
        	 if(!this.rendered){
        		 return;
        	 }
        	 
        	 var select = this.panel.find("select");
        	 if(this.selectedChannelStack){
        		  select.val(this.selectedChannelStack);
        	 }
         },
         
         getSelectedChannelStack: function(){
             return this.selectedChannelStack;
         },
         
         setSelectedChannelStack: function(channelStack){
        	 this.selectedChannelStack = channelStack;
        	 this.refresh();
             this.notifyChangeListeners();
         },
         
         addChangeListener: function(listener){
             this.listeners.addListener('change', listener);
         },
         
         notifyChangeListeners: function(){
             this.listeners.notifyListeners('change');
         }

    });
    
    //
    // CHANNEL STACK MANAGER
    //
    
    function ChannelStackManager(channelStacks) {
        this.init(channelStacks);
    }
    
    $.extend(ChannelStackManager.prototype, {

         init: function(channelStacks){
        	 this.channelStacks = channelStacks;
         },
         
         isSeriesNumberPresent: function(){
        	 return this.channelStacks.some(function(channelStack){
                return channelStack.seriesNumberOrNull;        		 
        	 });
         },
         
         isTimePointMissing: function(){
             return this.channelStacks.some(function(channelStack){
                 return channelStack.timePointOrNull == null;              
              });
         },
         
         isDepthMissing: function(){
             return this.channelStacks.some(function(channelStack){
                 return channelStack.depthOrNull == null;              
              });
         },
         
         isDepthConsistent: function(){
             var map = this.getChannelStackMap();
             var depthCounts = {};
             
             for(timePoint in map){
                 var entry = map[timePoint];
                 var depthCount = Object.keys(entry).length;
                 depthCounts[depthCount] = true;
             }
             
             return Object.keys(depthCounts).length == 1;
         },
         
         getTimePoints: function(){
        	 if(!this.timePoints){
                 var timePoints = {};
                 
                 this.channelStacks.forEach(function(channelStack){
                	 if(channelStack.timePointOrNull != null){
                		 timePoints[channelStack.timePointOrNull] = true;	 
                	 }
                 });
                 
                 this.timePoints = Object.keys(timePoints);
        	 }
        	 return this.timePoints;
         },
         
         getDepths: function(){
             if(!this.depths){
                 var depths = {};
                 
                 this.channelStacks.forEach(function(channelStack){
                     if(channelStack.depthOrNull != null){
                    	 depths[channelStack.depthOrNull] = true;    
                     }
                 });
                 
                 this.depths = Object.keys(depths);
             }
             return this.depths;
         },
         
         getChannelStack: function(timePoint, depthLevel){
        	 var map = this.getChannelStackMap();
        	 var entry = map[timePoint];
        	 
        	 if(entry){
        		 return entry[depthLevel];
        	 }else{
        		 return null;
        	 }
         },
         
         getChannelStacks: function(){
        	 return this.channelStacks;
         },
         
         getChannelStackMap: function(){
             if(!this.channelStackMap){
                 var map = {};
                 this.channelStacks.forEach(function(channelStack){
                     if(channelStack.timePointOrNull != null && channelStack.depthOrNull != null){
                         var entry = map[channelStack.timePointOrNull];
                         if(!entry){
                             entry = {};
                             map[channelStack.timePointOrNull] = entry;
                         }
                         entry[channelStack.depthOrNull] = channelStack;
                     }
                 });
                 this.channelStackMap = map;
             }
             return this.channelStackMap; 
         }
    });
    
    //
    // IMAGE
    //
    function ImageWidget() {
        this.init();
    }
    
    $.extend(ImageWidget.prototype, {

        init: function(){
        	this.panel = $("<div>")
        },
        
        render: function(){
        	$("<img>").appendTo(this.panel);
        	this.rendered = true;
        	this.refresh();
            return this.panel;
        },
        
        refresh: function(){
        	if(!this.rendered){
        		return;
        	}
        	
        	var url = this.dataStoreUrl;
        	url += "?sessionID=" + this.sessionToken;
        	url += "&dataset=" + this.dataSetCode;
        	url += "&channelStackId=" + this.channelStackId;

        	this.channels.forEach(function(channel){
        		url += "&channel=" + channel;
        	});
        	
        	if(this.resolution){
        		url += "&mode=thumbnail" + this.resolution;	
        	}else{
        		url += "&mode=thumbnail480x480";
        	}
        	
        	this.panel.find("img").attr("src", url);
        },
        
        setDataStoreUrl: function(dataStoreUrl){
        	this.dataStoreUrl = dataStoreUrl;
        	this.refresh();
        },
        
        setSessionToken: function(sessionToken){
        	this.sessionToken = sessionToken;
        	this.refresh();
        },
        
        setDataSetCode: function(dataSetCode){
        	this.dataSetCode = dataSetCode;
        	this.refresh();
        },
        
        setChannelStackId: function(channelStackId){
        	this.channelStackId = channelStackId;
        	this.refresh();
        },
        
        setChannels: function(channels){
        	this.channels = channels;
        	this.refresh();
        },
        
        setResolution: function(resolution){
        	this.resolution = resolution;
        	this.refresh();
        }
        
    });
    
    //
    // CALLBACK MANAGER
    //
    function CallbackManager(callback) {
    	this.init(callback);
    }
    
    $.extend(CallbackManager.prototype, {

    	init: function(callback){
    		this.callback = callback;
    		this.callbacks = {};
    	},
    	
        registerCallback: function(callback){
        	var manager = this;
        	
        	var wrapper = function(){
        		callback.apply(this, arguments);
        		
        		delete manager.callbacks[callback]
        		
        		for(c in manager.callbacks){
        		    return;        			
        		}
        		
        		manager.callback();
        	}
        	
        	this.callbacks[callback] = callback;
        	return wrapper;
        }
    });

    
    //
    // LISTENER MANAGER
    //
    function ListenerManager() {
    	this.init();
    }
    
    $.extend(ListenerManager.prototype, {

    	init: function(){
    		this.listeners = {};
    	},
    	
        addListener: function(eventType, listener){
        	if(!this.listeners[eventType]){
        		this.listeners[eventType] = []
        	}
        	this.listeners[eventType].push(listener);
        },
        
        notifyListeners: function(eventType){
            if(this.listeners[eventType]){
                this.listeners[eventType].forEach(function(listener){
                    listener();
                });
            }
        }
    });
    
    </script>
</body>
</html>
