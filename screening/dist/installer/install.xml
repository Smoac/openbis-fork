<?xml version="1.0" encoding="UTF-8" standalone="yes" ?>
<installation version="1.0">
  <info>
    <appname>openBIS</appname>
    <appversion>S106</appversion>
    <url>http://www.cisd.ethz.ch/software/openBIS</url>
  </info>

  <!-- Sets the installer window size. -->
  <guiprefs width="640" height="480" resizable="yes">
      <modifier key="useHeadingPanel" value="yes"/>
      <modifier key="headingImageOnLeft" value="yes"/>
      <modifier key="headingBackgroundColor" value="0xffffff"/>
  </guiprefs>

  <locale>
    <langpack iso3="eng" />
  </locale>

  <javaversion>1.6</javaversion>
  <requiresjdk>yes</requiresjdk>
  <os>
    <family>unix, mac</family>
  </os>

  <!-- The resources section. The ids must be these ones if you want to use the LicencePanel and/or the InfoPanel. -->
  <resources>
    <!-- res id="LicencePanel.licence" src="Licence.txt"/ -->
    <res id="TargetPanel.dir" src="@{installer.resourcedir}/default-install-dir.txt" />
    <res id="Heading.image" src="@{installer.resourcedir}/openbis_logo_229x100.png"/>
    <res id="userInputSpec.xml" src="@{installer.resourcedir}/userInputSpec.xml" />
    <res id="ProcessPanel.Spec.xml" src="@{installer.resourcedir}/backup-installation.xml"/>
  </resources>

  <variables>
    <!-- suppress the "target directory will be created" message -->
    <variable name="ShowCreateDirectoryMessage"  value="no" />
    <variable name="data.validation.error.title"  value="Error" />
    <variable name="installer.reversetitle"  value="$APP_NAME installation" />
    <variable name="DB.NAME"  value="openbis_@{installer.database.kind}" />
  </variables>

  <dynamicvariables>
      <variable name="INSTALL_BIN_PATH" value="$INSTALL_PATH/bin" />
      <variable name="INSTALL_OPENBIS_PATH" value="$INSTALL_PATH/servers/openBIS-server" />
      <variable name="INSTALL_DSS_PATH" value="$INSTALL_PATH/servers/datastore_server" />
  </dynamicvariables>

  <conditions>
    <condition type="java" id="isUpdateInstallation">
      <java>
        <class>ch.systemsx.cisd.openbis.installer.izpack.InstallationContext</class>
        <field>isUpdateInstallation</field>
      </java>
      <returnvalue type="boolean">true</returnvalue>
    </condition>
    <condition type="java" id="isFirstTimeInstallation">
      <java>
        <class>ch.systemsx.cisd.openbis.installer.izpack.InstallationContext</class>
        <field>isFirstTimeInstallation</field>
      </java>
      <returnvalue type="boolean">true</returnvalue>
    </condition>
  </conditions>

  <!-- The panels section. We indicate here which panels we want to use. The order will be respected. -->
  <panels>
    <panel classname="HelloPanel" />
    <!-- panel classname="LicencePanel"/ -->

    <panel classname="TargetPanel">
      <actions>
        <action stage="postvalidate" classname="ch.systemsx.cisd.openbis.installer.izpack.InitializeInstallationContextAction" />
      </actions>
    </panel>

    <panel classname="UserInputPanel" id="UserInputPanel.0" condition="isFirstTimeInstallation">
        <validator classname="ch.systemsx.cisd.openbis.installer.izpack.DBConnectionValidator"/>
    </panel>
    <panel classname="UserInputPanel" id="UserInputPanel.1" condition="isFirstTimeInstallation"/>
    
    <!--  create backup if needed -->
    <panel classname="ProcessPanel" condition="isUpdateInstallation" >
      <actions>
        <action stage="preactivate" classname="ch.systemsx.cisd.openbis.installer.izpack.PrepareInstallationBackupAction" />
      </actions>
    </panel>
    
    <panel classname="PacksPanel"/>
    <panel classname="InstallPanel" />
    <panel classname="FinishPanel" />
  </panels>


  <!-- The packs (packages) to be installed. -->
  <packs>
    <pack name="openBIS Server" required="yes" loose="yes">
      <description>The openBIS application server</description>
      <file src="openBIS-server-screening-SNAPSHOT-r21158.zip" targetdir="$INSTALL_PATH/servers" unpack="true" />
      <parsable targetfile="$INSTALL_OPENBIS_PATH/service.properties" />
      <!-- run post installation script for the openBIS server -->
      <executable targetfile="$INSTALL_OPENBIS_PATH/install.sh" stage="postinstall">
        <args>
          <arg value="$INSTALL_OPENBIS_PATH" />
          <arg value="$INSTALL_OPENBIS_PATH/service.properties" />
        </args>
      </executable>
    </pack>

    <pack name="Datastore Server" required="yes" loose="yes">
      <description>The data store server managing raw data</description>
      <file src="datastore_server-screening-SNAPSHOT-r21158.zip" targetdir="$INSTALL_PATH/servers" unpack="true" />
      <parsable targetfile="$INSTALL_DSS_PATH/etc/service.properties" />
      
      <!-- create a log folder and store folder -->
      <executable targetfile="/bin/mkdir" stage="postinstall" keep="true">
        <args>
          <arg value="-p" />
          <arg value="$INSTALL_DSS_PATH/log" />
          <arg value="$DSS.ROOT-DIR/store" />
        </args>
      </executable>
    </pack>

    <pack name="Administration Scripts" required="yes" loose="yes">
      <description>Scripts to facilitate openBIS administration</description>
      <file src="../ant/classes/bin" targetdir="$INSTALL_PATH" />

      <!--  set all *.sh files executable -->      
      <executable targetfile="/usr/bin/find" stage="postinstall" keep="true">
        <args>
          <arg value="$INSTALL_PATH" />
          <arg value="-type" />
          <arg value="f" />
          <arg value="-name" />
          <arg value="*.sh" />
          <arg value="-exec" />
          <arg value="/bin/chmod" />
          <arg value="744"/>
          <arg value="{}" />
          <arg value=";" />
        </args>
      </executable>
      
      <!-- restore the config from the pre-existing installation -->
      <executable targetfile="$INSTALL_BIN_PATH/restore-config-from-backup.sh" 
        stage="postinstall" condition="isUpdateInstallation" keep="true">
        <args>
          <arg value="$BACKUP_FOLDER" />
        </args>
      </executable>
    </pack>
    
    <pack name="HCS Jython dropboxes" required="yes" loose="yes">
      <description>A set of minimal Jython dropboxes for importing HCS data into openBIS</description>
      <file src="@{installer.resourcedir}/dropboxes" targetdir="$DSS.ROOT-DIR" />
      <file src="@{installer.resourcedir}/incoming-sample" targetdir="$DSS.ROOT-DIR" />
    </pack>
    
  </packs>

</installation>
