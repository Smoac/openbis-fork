<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
	<title>Sinergia</title>
	
	<!-- openBIS -->
	<script type="text/javascript" src="/openbis/resources/js/jquery.js"></script>
	<script type="text/javascript" src="/openbis/resources/js/openbis.js"></script>

	
	<!-- Third party libraries -->
	<link type="text/css" rel="stylesheet" href="./bootstrap/css/bootstrap.css" />
	<link type="text/css" rel="stylesheet" href="./bootstrap/css/bootstrap-responsive.css" />
	<link type="text/css" rel="stylesheet" href="./flowplayer/skin/minimalist.css" />
	<link type="text/css" rel="stylesheet" href="./dynatree/src/skin-vista/ui.dynatree.css" id="skinSheet">
	<script type="text/javascript" src="./js/jquery.blockUI.js"></script>
	<script type="text/javascript" src="./flowplayer/flowplayer.min.js"></script>
 	<script type="text/javascript" src="./dynatree/jquery/jquery-ui.custom.js"></script>
 	<script type="text/javascript" src="./dynatree/jquery/jquery.cookie.js"></script>
 	<script type="text/javascript" src="./dynatree/src/jquery.dynatree.js"></script>



	
	<!-- App files -->
	<link type="text/css" rel="stylesheet" href="./css/style.css" />
	<script type="text/javascript" src="./js/search.js"></script>

	<script type="text/javascript">
		//
		// Global variables
		//
		var openbis = new openbis();
		var experimentCode = 'CLUSTERS';
		var experimentIdentifier = '/SINERGIA/CLUSTERS/CLUSTERS';
		var sampleType ='CLUSTER';

		var allDataStores = null;
		var mainCluster = null;
		var clusters = [];

		var allDataSets = null;

		//
		// Login
		//
		$(document).ready(function() {
			//Attach function to form login
			var submitFunction = function(event) {
				event.preventDefault();
				 blockUIWithMessage();
				
				openbis.login($.trim($('#username').val()), $.trim($('#password').val()),
				function(data) {
					enterApp(data) 
				});
			}
			$("#loginForm").submit(submitFunction);
			
			//Avoid login if we got already a cookie
			openbis.ifRestoredSessionActive(function(data) { enterApp(data) });
		});

		function enterApp(data){
			if(data.result === null) {
				//Login not correct
				window.alert("Login information incorrect.");
				return;
			} 
			else {
				$("#login-form-div").hide();
				//Loading main experiment
				openbis.listExperimentsForIdentifiers([experimentIdentifier],
					function (data) {
						mainCluster = data.result[0];
						//Get datastores
						openbis.listDataStores(
							function(data) {
								allDataStores = data.result;
								loadAllDataSets(); //Get all datasets using the experiment
							}
						);

						
					}
				);

				//Build menu and load samples data structure
				searchSamplesWithType(sampleType,
					function(data) {
						buildLogout();
						buildData(data);
					}
				);
			}


		}
		
		//
		// Logout
		//
		function buildLogout() {
			$("#menu").append("<a class='logout-btn' href='javascript:logout()'>Logout <img src='./images/System-Logout-icon.png'></a>");
		}
 		function logout() {
 			openbis.logout(function(data) { 
                /*
                $("#menu").empty();
                $("#main").empty();
                clusters = [];
                $("#login-form-div").show();
                */
                location.reload();
            });
 		}

		//
		// Menu Setup
		//

		function getClusterWithCode(code) {
			for(var clusterIndex = 0; clusterIndex < clusters.length; clusterIndex++) {
				var auxCluster = clusters[clusterIndex];
				if(auxCluster.code === code) {
					return auxCluster;
				}
			}
			return null;
		}

		function buildData(dataToBuild) {
			var initalizeGenes = [];

			for (var i = 0; i < dataToBuild.length; i++) {
				clusters.push(dataToBuild[i]); //Build a general data structure

				var geneLevelCreatorJSRocks = function(dataCode) {
					var geneLevelCreator = function() {
						var callbackFunction =  function(data) {
							getClusterWithCode(dataCode).genes = data;

							if(initalizeGenes.length == 0) {
								buildMenu();
							} else {
								var nextCall = initalizeGenes.pop();
								nextCall();
							}
						}
						searchSamplesWithTypeAndCode("GENE", dataCode + ":*", callbackFunction);
					}
					return geneLevelCreator;
				}
				initalizeGenes.push(geneLevelCreatorJSRocks(dataToBuild[i].code));
			}

			var firstFunction = initalizeGenes.pop();
			firstFunction();
		}

		function buildMenu() {
			var $menu = $("<ul>");
			//$("#menu").append("<ul></ul>"); // this is equivalent to the above. It's only good for static things. The above is better for dynamic things, as in this case.
			var $experimentLevel = $("<li>", {'class' : 'folder expanded'})
										.append("<a href='javascript:showExperiment()'>" + experimentCode + "</a>");
			$menu
				.append($experimentLevel);

				var $samplesMenu = $("<ul>");
				$experimentLevel
					.append($samplesMenu);

				for (var i = 0; i < clusters.length; i++) {
					
					var $sampleLevel = $("<li>", {'class' : 'folder'})
											.append("<a href='javascript:showSamples(\""+clusters[i].identifier+"\")'>" + clusters[i].code + "</a>");
					$samplesMenu
						.append($sampleLevel);

					var $containedSamplesMenu = $("<ul>");
						$sampleLevel
								.append($containedSamplesMenu);

					for (var j = 0; j < clusters[i].genes.length; j++) {
									var cleanIdentifier = clusters[i].genes[j].identifier;
									var cleanGeneCode = clusters[i].genes[j].code.substring(clusters[i].genes[j].code.indexOf(":")+1);
									$containedSamplesMenu.append(
												$("<li>")
													.append($("<a>", {'href' : "javascript:showContainedSamples('" +  cleanIdentifier + "')"}).text(cleanGeneCode))
												);

					}
			}			

			$("#menu").append($menu);
			
			$("#menu").dynatree({
				onClick: function(node, e) {
					if(e.target.className === "dynatree-title" && node.data.href) {
						eval(node.data.href);
					}
				}
			});	
		}

		//
		// Navigation 
		//
		function showExperiment() {
			blockUIWithMessage();
			$("#main").empty();

			//Obtain PDF URL
			getDataSetFilesFor(null, "PDF", allDataStores[0].downloadUrl,
				function(files) {
					var pdfFileUrl = files[0];
					$("#main").append("<h1>Gene Clusters</h1>");
					$("#main").append("<iframe src='" + pdfFileUrl + "' style='width:100%; height:" + $(window).height() + "px; ' frameborder='0'></iframe>");
					$.unblockUI();
				}
			);
		}

		function showSamples(sampleIdentifier) {
			blockUIWithMessage();
			var displayName = sampleIdentifier.substring(10);
			$("#main").empty();

			//Obtain PDF URL
			getDataSetFilesFor(sampleIdentifier, "PDF", allDataStores[0].downloadUrl,
				function(pdfFiles) {
					var pdfFileUrl = pdfFiles[0];
					$("#main").append("<h1>" + displayName + "</h1>");
					$("#main").append("<h2>Genes: </h2>");
					$("#main").append("<iframe src='" + pdfFileUrl + "' style='width:100%; height:" + $(window).height()/2 + "px; ' frameborder='0'></iframe>");
					$("#main").append("<h2>Representative Images: </h2>");

					//Obtain Image URL
					getDataSetFilesFor(sampleIdentifier, "PNG_IMAGES", allDataStores[0].downloadUrl,
						function(pngFiles) {
							for(var i = 0; i < pngFiles.length; i++) {
								$("#main").append("<a target='_blank' href='" + pngFiles[i] + "'><img src='" + pngFiles[i] + "' style='width: 20%; min-width:220px;' /></a>");
							}
							$.unblockUI();
						}
					);
				}
			);
		}

		function showContainedSamples(sampleIdentifier) {
			blockUIWithMessage();
			var displayName = sampleIdentifier.substring(10);
			$("#main").empty();

			//Obtain PDF URL
			getDataSetFilesFor(sampleIdentifier, "PDF", allDataStores[0].downloadUrl,
				function(pdfFiles) {
					$("#main").append("<h1>" + displayName + "</h1>");

					var component = "<div>";
					for(var i = 0; i < pdfFiles.length; i++) {
						var pdfFileUrl = pdfFiles[i];
						
						component += "<div style='margin-right:20px;'>";
						if(pdfFileUrl.indexOf("rnaProfile.pdf") !== -1) {
							component += "<h2>RNA Profile:</h2>";
						} else if(pdfFileUrl.indexOf("geneProfile.pdf") !== -1) {
							component += "<h2>Gene Profile:</h2>";
						}
						component += "<iframe src='" + pdfFileUrl + "' style='width:100%; ' frameborder='0'></iframe>";
						component += "</div>";	
					}
					$("#main").append(component + "</div>");

					//Movies Containers
					$("#main").append("<div id='controlVideosContainer'><h2>Control Videos:</h2></div>");
					$("#main").append("<div id='geneVideosContainer'><h2>Gene Videos:</h2></div>");

					//Load Movies URL
					getDataSetFilesFor(sampleIdentifier, "VIDEOS", allDataStores[0].downloadUrl,
						function(videoFiles) {
							var geneVideosURLs = [];
							var controlVideosURLs = [];

							for(var i = 0; i < videoFiles.length; i++) {

								if( videoFiles[i].indexOf("/original/geneVideos/") !== -1) {
									geneVideosURLs.push(videoFiles[i]);
								} else if( videoFiles[i].indexOf("/original/controlVideos/") !== -1) {
									controlVideosURLs.push(videoFiles[i]);
								}
								
							}
							
							$("#geneVideosContainer").append(getPlayerWidget('geneVideosContainerPlayer',geneVideosURLs));
							$("#controlVideosContainer").append(getPlayerWidget('controlVideosContainerPlayer',controlVideosURLs));
							
							$.unblockUI();
						}
					);

					


				}
			);
		}

		//
		// Data Loader
		//
    	function loadAllDataSets() {
    		openbis.listDataSetsForExperiments([mainCluster], null,
    			function(datasets) {
    				allDataSets = datasets.result;
    				showExperiment();
    			}
    		);
    	};

    	function getDataSetFilesFor(sampleIdentifier, dataSetTypeCode, datastoreDownloadURL, callback) {
    		//Obtain datasets
			var datasets = [];
			for(var i = 0; i < allDataSets.length; i++) {
				if(	allDataSets[i].sampleIdentifierOrNull === sampleIdentifier && 
					allDataSets[i].dataSetTypeCode === dataSetTypeCode ) {
					datasets.push(allDataSets[i]);
				}
			}
			//List dataset files
			var allDatasetFiles = [];

			var callBackForFiles = function(datasetFiles) {
				if(datasetFiles) {
					var dataset = datasets.pop();

					for(var i = 0; i < datasetFiles.result.length; i++) {
						if(!datasetFiles.result[i].isDirectory) {
							var dowloadUrl = datastoreDownloadURL + '/' + dataset.code + "/" + datasetFiles.result[i].pathInDataSet + "?sessionID=" + openbis.getSession();
							allDatasetFiles.push(dowloadUrl);
						}
					}
				}

				if(datasets.length === 0) {
					callback(allDatasetFiles);
				} else {
					openbis.listFilesForDataSet(datasets[datasets.length-1].code, "/", true, callBackForFiles);
				}
			};

			callBackForFiles(null);
    	}

    	//
    	//Widget
    	//
    	function getPlayerWidget(id, videoListURL) {
    	 var $playerWidgetContainer = $("<div>", { 'class' : 'row'});

    	 var $paddingLeft = $("<div>", { 'class' : 'span2'});
         var $playerWidget = $("<div>", { 'class' : 'span8 playerWidget'});
         var $paddingRight = $("<div>", { 'class' : 'span2'});

         var $videoList = $("<div>", { 'class' : 'span2 videoList'});
         var $player = $("<div>", { 'id': id, 'class' : 'span6 flowplayer', 'data-swf' : './flowplayer/flowplayer.swf' });
         
         $playerWidget.append($videoList);
         $playerWidget.append($player);

         for(var i = 0; i < videoListURL.length; i++) {
            var greatJSObjectOrientation = function() {
               var idForFunc = id;
               var urlForFun = videoListURL[i];
              
               $videoLink = $("<a>").click(function() {
                  $("#" + idForFunc).empty();
                  $("#"+idForFunc).flowplayer({
									playlist: [
										[
											{ mp4:   urlForFun }
										]
									]
								});

               }).html("Video " + (i+1));

               $videoList.append($videoLink);
               $videoList.append($("<br>"));
            }
            
            greatJSObjectOrientation();
         }

         $playerWidgetContainer.append($paddingLeft);
         $playerWidgetContainer.append($playerWidget);
         $playerWidgetContainer.append($paddingRight);
		 
         return $playerWidgetContainer;
      }

      //
      // BlockUI
      //
      blockUIWithMessage = function(message) {

        var css = { 
                    'border': 'none', 
                    'padding': '10px',
                    '-webkit-border-radius': '10px', 
                    '-moz-border-radius': '10px', 
                    'border-radius' : '10px',
                    'box-shadow' : '0px 0px 10px rgba(50, 50, 50, 0.8)',
                    '-webkit-box-shadow' : '0px 0px 10px rgba(50, 50, 50, 0.8)',
                    '-moz-box-shadow' : '0px 0px 10px rgba(50, 50, 50, 0.8)',
                    'cursor' : 'default'
        };
        
        $.blockUI({ message: '<h1><img src="./css/busy.gif" /> Please wait...</h1>' , css: css });
    }



	</script>
</head>






<body class="bodyLogin">
    <div id="login-form-div" class="loginForm">
            <img class="loginLogo" src="./images/openBIS_Logo.png" alt="openBIS" />
            <h1>Sinergia Project</h1>
            
            <form id="loginForm" action="javascript:">
                <fieldset>
                        <div class='loginInputBox'>
                            <input placeholder="User Name" id="username" type="text" required="required">
                        </div>
                    
                        <div class='loginInputBox'>
                            <input placeholder="Password" id="password" type="password" required="required">
                        </div>
                    
                        <button class="btn" id="login-button" type="submit"><i class="icon-arrow-right"></i></button>
                </fieldset>
            </form>
            
            <center>
                <div style="margin-bottom: 5px; margin-top: 100px;">Compatible With:</div>
                <img src="./images/browser-icon-chrome.png" style="width: 43px; height:43px;" /><img src="./images/browser-icon-safari.png" style="width: 43px; height:43px;" /><img src="./images/browser-icon-firefox.png" style="width: 43px; height:43px;" />
            </center>
    </div>
    <!--
	<div class='flowplayer color-light' style='width:30%;' data-swf='./flowplayer/flowplayer.swf'>
	<video preload='none' controls>
		<source src='https://mat-openbis.dbm.unibas.ch:8444/datastore_server/20131022120243488-7519/original/geneVideos/p1g5_v168_cell5.mp4?sessionID=barillac-131113140031685x4B608B9F5412933B1D49F2FFC9F148FB' type='video/mp4'>
		</video>
	</div>
	-->
	<div class="container-fluid">
		<div class="row-fluid">
			<div id ="menu" class="span2"></div>
			<div id ="main" class="span10"></div>
		</div>
	</div>
</body>

</html>
