<project name="screening" default="ci" basedir="..">
  <import file="../../openbis/build/build.xml" />
  <import file="../../datastore_server/build/build.xml" />
  <project-classpath name="ecp" classes="${classes}" />
	<project-classpath name="ecp.gwt" classes="${targets}/www/WEB-INF/classes" />
  
  <property name="original.dist" value="dist" />
  <property name="mainfolder" value="screening" />
  <property name="variant" value="-screening" />

  <property name="dist.screening-api" value="${dist}/screening_api" />
  <property name="dist.screening-api.lib" value="${dist.screening-api}" />
  <property name="dist.screening-api.jar" value="${dist.screening-api.lib}/openbis_screening_api.jar" />
  <property name="dist.screening-api-batteries-included.jar" value="${dist.screening-api.lib}/openbis_screening_api-batteries_included.jar" />
  <property name="dist.screening-api.src" value="${dist.screening-api}/openbis_screening_api_source.zip" />
	<property name="dist.screening-api.javadoc" value="${dist.screening-api}/doc" />
  <property name="dist.screening-api.javadoc.zip" value="${dist.screening-api}/openbis_screening_api_javadoc.zip" />

	<property name="classes.screening" value="../screening/targets/ant/classes" />
	<property name="classes.openbis" value="../openbis/targets/ant/classes" />
	<property name="classes.common-server" value="../server-common/targets/ant/classes" />
  <property name="classes.common" value="../common/targets/ant/classes" />
	
  <target name="compile" depends="build-common.compile, clean" />

  <!--
        // Task for creating distributions
        -->
	
  <target name="dist" depends="openbis.make-dist, make-full-dss-dist, dss-plugin-jar, datastore_server.make-plugin-dist, screening-api">
  	<zip update="true" destfile="${server.dist.file}">
  		<zipfileset file="${jars.to.be.signed.zip}"/>
  	</zip>
  	<delete file="${jars.to.be.signed.zip}"/>
 	</target>
  
  <target name="dss-plugin-jar" depends="compile">
		<mkdir dir="${dist}/data" />
		<mkdir dir="${dist}/etc" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<jar destfile="${plugin-jar.file}">
			<fileset dir="${classes}">
				<include name="ch/systemsx/cisd/openbis/dss/**/*.class" />
				<include name="ch/systemsx/cisd/openbis/plugin/screening/shared/**/*.class" />
				<include name="ch/systemsx/cisd/utils/**/*.class" />
				<include name="*.class" />
				<include name="${build.info.filename}" />
			</fileset>
    	<zipfileset src="${lib}/jhdf5/cisd-jhdf5-batteries_included_lin_win_mac.jar">
    		<exclude name="META_INF/*"/>
    		<include name="ch/systemsx/cisd/hdf5/**/*"/>
    		<include name="ncsa/**/*"/>
    	</zipfileset>
    	<fileset dir="${lib}/hdf5">
    		<include name="native/**/*"/>
    	</fileset>
    	<fileset dir="${lib}/nativedata">
    		<include name="native/**/*"/>
    	</fileset>
    	<fileset dir="${lib}/unix">
    		<include name="native/**/*"/>
    	</fileset>
			<fileset dir="source">
				<include name="**/*.sql" />
			</fileset>	
			<fileset dir="${sources}">
				<include name="*dss*.xml" />
			</fileset>	
			<manifest>
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</jar>
  	<copy todir="${dist}/data">
  		<fileset dir="dist/data" />
  	</copy>
    <copy todir="${dist}/etc">
      <fileset dir="dist/etc">
        <include name="tabular-data-graph.properties" />
      </fileset>
    </copy>
  </target>
	
  <target name="make-full-dss-dist" depends="datastore_server.prepare-dist-libs, compute-dss-checksum">
    <jar update="true" destfile="${dss-jar.file}">
    	<zipfileset src="${lib}/jhdf5/cisd-jhdf5-batteries_included_lin_win_mac.jar">
    		<exclude name="META_INF/*"/>
    		<include name="ch/systemsx/cisd/hdf5/**/*"/>
    		<include name="ncsa/**/*"/>
    	</zipfileset>
      <fileset dir="source">
        <include name="**/*.sql" />
      </fileset>
    	<fileset dir="${lib}/hdf5">
    		<include name="native/**/*"/>
    	</fileset>
    	<fileset dir="${lib}/nativedata">
    		<include name="native/**/*"/>
    	</fileset>
    	<fileset dir="${lib}/unix">
    		<include name="native/**/*"/>
    	</fileset>
    </jar>
    <copy file="${lib}/sybit-image-viewer/image-viewer.jar" todir="${dist.datastore_server.lib}" />
  	<copy todir="${dist.datastore_server}/data">
  		<fileset dir="${original.dist}/data" />
  	</copy>
    <copy todir="${dist.datastore_server}/etc">
      <fileset dir="${original.dist}/etc">
        <include name="tabular-data-graph.properties" />
      </fileset>
    </copy>
  	<antcall target="datastore_server.create-distribution" />
  </target>
	
	
  <!-- 
      Build the checksum file.
  -->
  <target name="compute-dss-checksum" depends="compute-separate-dss-checksums">
  	<concat-checksums />
  </target>
	
  <!-- 
      Compute checksum files, one per configuration file, and place them
      in the ${dist} dir. 
      
      The pattern shown in the file should be:
        hash[two spaces]path_in_distribution_to_file
      e.g.,
        {0}  [folder of file]{1}
  -->
  <target name="compute-separate-dss-checksums">
    <checksum todir="${dist}" pattern="{0}  etc/{1}">
      <fileset dir="dist/etc">
        <include name="service.properties" />
      	<include name="tabular-data-graph.properties" />
        <include name="log.xml" />
        <include name="openBIS.keystore" />
      </fileset>
    </checksum>
	  <checksum todir="${dist}" pattern="{0}  bin/{1}">
		  <fileset dir="../datastore_server/dist/etc">
		  	<include name="datastore_server.conf" />
		  </fileset>
		  <fileset dir="../datastore_server/dist">
		  	<include name="datastore_server.sh" />
		  </fileset>
	  </checksum>
  </target>
	
  <!--
        // Task for continuous integration server.
        -->
  <target name="ci" depends="build-common.ci, dist, check-dependencies" />

  <!--
        // Compiles the javascript using GWT compiler.
        -->
  <target name="compile-javascript" depends="prepare-web-client" description="Compiles the javascript using GWT compiler.">
    <antcall target="compile-gwt-module">
      <param name="gwt.module.name" value="ch.systemsx.cisd.openbis.plugin.screening.OpenBIS" />
    </antcall>
  </target>
	
	<!-- 
		Use this only if you want to use image viewer (screening.jar needs to be created and it slows down the build process).
		Otherwise use prepare-gwt.
	-->
	<target name="prepare-gwt-with-image-viewer" depends="prepare-gwt, jar"/>
	
	<target name="jar" depends="openbis.jar">
	  <property name="dist.file.name"
	            value="${ant.project.name}-${version.number}-r${revision.number}" />
	  <property name="jars.to.be.signed" value="${dist.file.name}_jars_to_be_signed" />
	  <property name="jars.to.be.signed.dir" value="${targets}/${jars.to.be.signed}" />
	  <property name="jars.to.be.signed.zip" value="${dist}/${jars.to.be.signed}.zip" />
		<property name="targets.www.openbis" value="${targets.www}/ch.systemsx.cisd.openbis.plugin.screening.OpenBIS"/>
			
		<mkdir dir="${targets.www.openbis}" />
		<delete dir="${jars.to.be.signed.dir}" />
		<mkdir dir="${jars.to.be.signed.dir}" />
		<zip update="true" destfile="${dist}/${jar.file.name}">
	    <zipfileset src="${lib}/gwt2.0/gwt-user.jar">
	      <include name="com/google/gwt/user/client/rpc/IsSerializable.class" />
	      <include name="com/google/gwt/user/client/rpc/SerializableException.class" />
	    </zipfileset>
	  </zip>
		

		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${dist}" />
			<param name="jar" value="${jar.file.name}" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/cisd-base" />
			<param name="jar" value="cisd-base.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/sybit-image-viewer" />
			<param name="jar" value="image-viewer.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring" />
			<param name="jar" value="spring-web.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring" />
			<param name="jar" value="spring-context.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring" />
			<param name="jar" value="spring-beans.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring" />
			<param name="jar" value="spring-core.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring" />
			<param name="jar" value="spring-aop.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring/third-party" />
			<param name="jar" value="aopalliance.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/spring/third-party" />
			<param name="jar" value="stream-supporting-httpinvoker.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/commons-httpclient" />
			<param name="jar" value="commons-httpclient.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/commons-codec" />
			<param name="jar" value="commons-codec.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/commons-io" />
			<param name="jar" value="commons-io.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/commons-lang" />
			<param name="jar" value="commons-lang.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/commons-logging" />
			<param name="jar" value="commons-logging.jar" />
		</antcall>
		<antcall target="copy-and-sign-jar">
			<param name="dir" value="${lib}/imagej" />
			<param name="jar" value="ij.jar" />
		</antcall>
		<zip destfile="${jars.to.be.signed.zip}"
		     basedir="${targets}"
		     includes="${jars.to.be.signed}/**" />
    <delete dir="${jars.to.be.signed.dir}" failonerror="true" />
	</target>
	
	<target name="copy-and-sign-jar">
		<copy file="${dir}/${jar}" todir="${webapp.dist}" />
		<copy file="${dir}/${jar}" todir="${jars.to.be.signed.dir}" />
		<signjar jar="${webapp.dist}/${jar}"
		         keystore="etc/dev.keystore"
		         alias="openbis"
		         storepass="openbistest"/>
		<copy file="${webapp.dist}/${jar}" todir="${targets.www.openbis}"/>
	</target>


  <!--
        // Creates WAR file.
        -->
  <target name="war" depends="openbis.war" description="Creates project war file.">
    <war warfile="${webapp.file}" update="true">
      <classes prefix="WEB-INF/classes/screening" dir="source">
        <include name="**/*.sql" />
      </classes>
      <classes dir="../openbis/${sources}">
        <include name="**/*.xml" />
        <exclude name="**/*.gwt.xml" />
        <include name="**/*.xsd" />
      </classes>
      <lib dir="${lib}/jaxb">
        <include name="*.jar" />
      </lib>
      <lib dir="${lib}/eodsql">
        <include name="*.jar" />
      </lib>
      <lib dir="${lib}/fast-md5">
        <include name="*.jar" />
      </lib>
      <lib dir="${lib}/csv">
        <include name="*.jar" />
      </lib>
    </war>
  </target>

  <target name="check-dictionary-syntax" description="Parse *-dictionary.js and check that the syntax is correct.">
    <antcall target="check-javascript-syntax">
      <param name="javascript-file"
        value="../screening/${sources}/ch/systemsx/cisd/openbis/plugin/screening/client/web/public/screening-dictionary.js" />
    </antcall>
  </target>
  
  <!-- ++++++++++++++++++++++++++++++ API ++++++++++++++++++++++++++++++ -->
    
  <target name="screening-api-doc">
    <javadoc 
      destdir="${dist.screening-api.javadoc}" 
      access="public" 
      author="false" 
      version="false" 
      classpath="${ecp}:${classes.screening}:${classes.common}:${classes.common-server}">
      <packageset dir="${sources}">
        <include name="ch/systemsx/cisd/openbis/plugin/screening/client/api/v1/**" />
        <include name="ch/systemsx/cisd/openbis/plugin/screening/shared/api/v1/dto/**" />
      </packageset>
    </javadoc>
    <zip destfile="${dist.screening-api.javadoc.zip}">
      <zipfileset dir="${dist.screening-api.javadoc}" includes="**" />
    </zip>
    <delete dir="${dist.screening-api.javadoc}" />
    <zip destfile="${dist.screening-api.src}">
      <zipfileset dir="${sources}" includes="ch/systemsx/cisd/openbis/plugin/screening/shared/api/v1/dto/**" />
      <zipfileset dir="${sources}" includes="ch/systemsx/cisd/openbis/plugin/screening/client/api/v1/*Facade.java" />
    </zip>
  	
  </target>

  <!-- 
  		To test the API you can use
  		   java -jar lib/openbis_screening_api.jar USER PASSWD OPENBIS_SERVER_URL
   -->
  <target name="screening-api-libs">
    <mkdir dir="${dist.screening-api.lib}" />
    <build-info revision="revision.number" version="version.number" clean="clean.flag" />
    <echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
    <recursive-jar destfile="${dist.screening-api.jar}">
      <fileset dir="${classes.screening}">
        <include name="OpenBISScreeningML*.class" />
        <include name="ch/systemsx/cisd/common/api/**/*.class" />
        <exclude name="ch/systemsx/cisd/common/api/server/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/dss/client/api/v1/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/dss/generic/shared/api/v1/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/dss/generic/shared/api/authorization/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/dss/screening/shared/api/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/generic/shared/basic/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/generic/shared/api/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/generic/shared/authorization/annotation/**/*.class" />
      	<include name="ch/systemsx/cisd/openbis/plugin/screening/shared/api/**/*.class" />
       	<include name="ch/systemsx/cisd/openbis/plugin/screening/client/api/**/*.class" />
       	<include name="ch/systemsx/cisd/openbis/plugin/screening/client/cli/**/*.class" />
       	<include name="${build.info.filename}" />
      </fileset>
    	<manifest>
      	<attribute name="Main-Class" value="ch.systemsx.cisd.openbis.plugin.screening.client.api.v1.ScreeningClientApiTest" />
        <attribute name="Class-Path" value="spring-ext.jar" />
        <attribute name="Version" value="${version.number}" />
        <attribute name="Build-Number"
                   value="${version.number} (r${revision.number},${clean.flag})" />
      </manifest>
    </recursive-jar>
  	<jar update="true" destfile="${dist.screening-api.jar}">
  		<fileset dir="${classes.openbis}">
  		     	<include name="ch/systemsx/cisd/openbis/generic/client/cli/Login*.class" />
			     	<include name="ch/systemsx/cisd/openbis/generic/shared/api/v1/**/*.class" />
  		</fileset> 
  		<fileset dir="${classes.common-server}">
  		     	<include name="ch/systemsx/cisd/common/spring/HttpInvokerUtils.class" />
  		</fileset> 
      <fileset dir="${classes.common}">
            <include name="ch/systemsx/cisd/common/exceptions/**/*.class" />
		        <include name="ch/systemsx/cisd/common/api/*.class" />
            <include name="ch/systemsx/cisd/common/io/ConcatenatedFileOutputStreamWriter.class" />
            <include name="ch/systemsx/cisd/common/io/ConcatenatedContentInputStream.class" />
            <include name="ch/systemsx/cisd/common/io/FileBasedContent.class" />
            <include name="ch/systemsx/cisd/common/io/IContent.class" />
      </fileset> 
    </jar>
		<zip update="true" destfile="${dist.screening-api.jar}">
	    <zipfileset src="${lib}/gwt2.0/gwt-user.jar">
	      <include name="com/google/gwt/user/client/rpc/IsSerializable.class" />
	      <include name="com/google/gwt/user/client/rpc/SerializableException.class" />
	    </zipfileset>
	  </zip>
    <recursive-jar destfile="${dist.screening-api.lib}/spring-ext.jar">
      <zipfileset src="${lib}/spring/spring.jar" />
      <zipfileset src="${lib}/spring/third-party/stream-supporting-httpinvoker.jar" />
      <zipfileset src="${lib}/commons-logging/commons-logging.jar" />
      <zipfileset src="${lib}/commons-httpclient/commons-httpclient.jar" />
      <zipfileset src="${lib}/commons-codec/commons-codec.jar" />
      <zipfileset src="${lib}/log4j/log4j.jar" />     
      <zipfileset src="${lib}/jline/jline.jar" />     
      <zipfileset src="${lib}/cisd-args4j/cisd-args4j.jar" />     
      <zipfileset src="${lib}/cisd-base/cisd-base.jar" />     
      <zipfileset src="${lib}/jython/standalone/jython.jar" />     
  	</recursive-jar>
  	<recursive-jar destfile="${dist.screening-api-batteries-included.jar}">
      <zipfileset src="${dist.screening-api.lib}/spring-ext.jar" />
      <zipfileset src="${dist.screening-api.jar}" />
  	</recursive-jar>
    <copy todir="${dist.screening-api}">
      <fileset dir="${original.dist}/api" />
    </copy>
  </target>

	<target name="screening-api" depends="screening-api-doc, screening-api-libs" >
     <zip destfile="${dist}/screening-api-${version.number}-r${revision.number}.zip">
      <zipfileset dir="${dist.screening-api}" includes="**" />
      <zipfileset dir="${original.dist}/doc" />
     </zip>
    <delete dir="${dist.screening-api}" />
  </target>

  
  <!-- ++++++++++++++++++++++++++++++ END API ++++++++++++++++++++++++++++++ -->
  
  <!-- ++++++++++++++++++++++++++++++ ECLIPSE TEST MODE ++++++++++++++++++++++++++++++ -->

  <!-- This is a copy of the openBIS version, the only difference is the value of ecp.gwt variable  -->
  
  <!--
    // // Compile Java to javscript, assuming that prepare-gwt has already been run // // Must pass in module-test.path
    and module-test.module as arguments // e.g., // <{property,param} name="module-test.path" value="openbis-test" /> //
    <{property,param} name="module-test.module" value="ch.systemsx.cisd.openbis.OpenBIS" /> //
  -->
  <target name="screening-compile-module-test" description="Compile the module test mode">
    <delete dir="${targets.www}/${module-test.path}" />
    <java classpath="${ecp}:${ecp.gwt}:${gwt.lib}/gwt-dev.jar:${gwt.user.lib}:../openbis/${sources}:${sources}:../common/${sources}"
      classname="com.google.gwt.dev.Compiler" fork="true">
      <jvmarg value="-Xmx512M" />
      <arg value="-war" />
      <arg value="${targets.www}" />
      <arg value="${module-test.module}Safari" />
      <arg value="-draftCompile" />
      <arg value="-style" />
      <arg value="PRETTY" />
    </java>
    <copy todir="${targets.www}/${module-test.path}">
      <fileset dir="${targets.www}/${module-test.module}" />
    </copy>
  </target>

  <!--
    // // Run the production mode, assuming compile-module-test has already been run // // Must pass in
    module-test.path, module-test.module, and module-test.db-kind as arguments // e.g., // <{property,param}
    name="module-test.path" value="openbis-test" /> // <{property,param} name="module-test.module"
    value="ch.systemsx.cisd.openbis.OpenBIS" /> //
  -->
  <target name="screening-run-module-test" description="Run the module test mode">
    <java failonerror="true" fork="true" classname="com.google.gwt.dev.DevMode">
      <classpath>
        <pathelement location="${sources}" />
        <pathelement location="../openbis/${sources}" />
        <pathelement path="${ecp}" />
        <pathelement path="${ecp.gwt}" />
        <pathelement location="${gwt.lib}/gwt-dev.jar" />
        <pathelement location="${gwt.lib}/gwt-user.jar" />
      </classpath>
      <jvmarg value="-Xmx512M" />
      <jvmarg value="-ea" />
      <sysproperty key="log4j.configuration" file="etc/log.xml" />
      <sysproperty key="javax.net.ssl.trustStore" file="dist/server/openBIS.keystore" />

      <!-- Arguments to com.google.gwt.dev.DevMode -->
      <!-- Provide two startup urls : one for the compiled version, one for the normal dev version -->
      <arg value="-startupUrl" />
      <arg value="${module-test.path}/index.html" />
      <arg value="-startupUrl" />
      <arg value="${module-test.module}/index.html" />

      <arg value="${module-test.module}" />
      <arg value="-war" />
      <arg value="targets/www" />
      <arg value="-logLevel" />
      <arg value="WARN" />
    </java>
  </target>

	<!-- 
		Use this only if you want to use image viewer (screening.jar needs to be created and it slows down the build process).
		Otherwise use screening-test-compile-and-run.
	-->
	<target name="screening-test-compile-and-run-with-image-viewer" description="Compile and run the screening openbis from Eclipse with support for image viewer">
	    <antcall target="screening-compile-module-test">
	      <param name="module-test.path" value="openbis-test-screening" />
	      <param name="module-test.module" value="ch.systemsx.cisd.openbis.plugin.screening.OpenBIS" />
	    </antcall>
	  	<antcall target="jar"/>
	    <antcall target="screening-test-run" />
  </target>
	
	<target name="screening-test-compile-and-run" description="Compile and run the screening openbis from Eclipse (no support for image viewer)">
	    <antcall target="screening-compile-module-test">
	      <param name="module-test.path" value="openbis-test-screening" />
	      <param name="module-test.module" value="ch.systemsx.cisd.openbis.plugin.screening.OpenBIS" />
	    </antcall>
	    <antcall target="screening-test-run" />
	  </target>

	<target name="screening-test-compile-no-run" description="Compile the screening openbis from Eclipse (no support for image viewer)">
	    <antcall target="screening-compile-module-test">
	      <param name="module-test.path" value="openbis-test-screening" />
	      <param name="module-test.module" value="ch.systemsx.cisd.openbis.plugin.screening.OpenBIS" />
	    </antcall>
	  </target>
		
  <target name="screening-test-run" description="run the screening openbis from Eclipse">
    <antcall target="screening-run-module-test">
      <param name="module-test.path" value="openbis-test-screening" />
      <param name="module-test.module" value="ch.systemsx.cisd.openbis.plugin.screening.OpenBIS" />
    </antcall>
  </target>
  
  <!-- ++++++++++++++++++++++++++++++ END ECLIPSE TEST MODE ++++++++++++++++++++++++++++++ -->
  
</project>