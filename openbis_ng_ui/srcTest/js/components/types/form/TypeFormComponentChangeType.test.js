import TypeFormComponentTest from '@srcTest/js/components/types/form/TypeFormComponentTest.js'
import fixture from '@srcTest/js/common/fixture.js'

let common = null

beforeEach(() => {
  common = new TypeFormComponentTest()
  common.beforeEach()
})

describe(TypeFormComponentTest.SUITE, () => {
  test('change type', testChangeType)
})

async function testChangeType() {
  common.facade.loadValidationPlugins.mockReturnValue(
    Promise.resolve([fixture.TEST_SAMPLE_TYPE_DTO.validationPlugin])
  )

  const form = await common.mountExisting(fixture.TEST_SAMPLE_TYPE_DTO)

  form.expectJSON({
    preview: {
      header: {
        code: {
          label: 'Code',
          value: null,
          enabled: false,
          mode: 'edit'
        }
      }
    },
    parameters: {
      type: {
        title: 'Object Type',
        autoGeneratedCode: {
          label: 'Generate Codes',
          value: false,
          mode: 'view'
        },
        generatedCodePrefix: {
          label: 'Generated code prefix',
          value: 'TEST_PREFIX_',
          mode: 'view'
        }
      }
    },
    buttons: {
      message: null
    }
  })

  form.getButtons().getEdit().click()
  await form.update()

  form.expectJSON({
    preview: {
      header: {
        code: {
          label: 'Code',
          value: null,
          enabled: true,
          mode: 'edit'
        }
      }
    }
  })

  form.getParameters().getType().getAutoGeneratedCode().change(true)
  form.getParameters().getType().getGeneratedCodePrefix().change('NEW_PREFIX_')
  await form.update()

  form.expectJSON({
    preview: {
      header: {
        code: {
          label: 'Code',
          value: 'NEW_PREFIX_',
          enabled: false,
          mode: 'edit'
        }
      }
    },
    parameters: {
      type: {
        title: 'Object Type',
        autoGeneratedCode: {
          label: 'Generate Codes',
          value: true,
          enabled: true,
          mode: 'edit'
        },
        generatedCodePrefix: {
          label: 'Generated code prefix',
          value: 'NEW_PREFIX_',
          enabled: true,
          mode: 'edit'
        }
      }
    },
    buttons: {
      message: {
        text: 'You have unsaved changes',
        type: 'warning'
      }
    }
  })
}
