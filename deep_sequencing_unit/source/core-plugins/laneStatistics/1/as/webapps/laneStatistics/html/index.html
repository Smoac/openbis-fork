<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="d3.layout.js"></script>
    <script type="text/javascript" src="/openbis/resources/js/jquery.js"></script>
    <script type="text/javascript" src="pie.js"></script>
    <script type="text/javascript" src="/openbis/resources/js/openbis.js"></script>
    <script type="text/javascript" src="openbis-dsu.js"></script>
    <style type="text/css">

        .axis path,
        .axis line {
                     fill: none;
                     stroke: #000;
                     shape-rendering: crispEdges;
        }

	.axis text {
		font-family: sans-serif;
		font-size: 10px;
        }

        table.tableStats {
		font-family: sans-serif;
		font-size: 14px;
                text-align: right;
	}
        div.tooltip {   
          position: absolute;           
	  text-align: center;           
	  width: 100px;                  
	  height: 42px;                 
	  padding: 2px;             
	  font: 12px sans-serif;        
	  background: LightSalmon;
	  border: 0px;      
	  border-radius: 8px;           
	  pointer-events: none;         
	}

</style>
  </head>
  <body>
  <script>
  
  statisticsArray = []
 
  dsu = new openbis_dsu('/openbis/openbis', '/datastore_server');
  var webAppContext = new openbisWebAppContext();
  dsu.server.useSession(webAppContext.getSessionId());
  var dataSetProperties;
  dsu.retrieveDataSetsForSample(webAppContext.getEntityIdentifier(), getProperties);
 
  function getProperties(dataSetProperties) {
    for (var i = 0; i < dataSetProperties.result.length; i++) {

      statisticsArray.push({'percRawClustersPerLane': parseFloat(dataSetProperties.result[i].properties.PERCENTAGE_RAW_CLUSTERS_PER_LANE),
                            'index1': dataSetProperties.result[i].properties.BARCODE,
                            'index2': dataSetProperties.result[i].properties.INDEX2,
                            'externalSampleName' : dataSetProperties.result[i].properties.EXTERNAL_SAMPLE_NAME,
                            'percFilteringPass' : parseFloat(dataSetProperties.result[i].properties.PERCENTAGE_PASSED_FILTERING),
                            'rawYieldMbases' : dataSetProperties.result[i].properties.RAW_YIELD_MBASES,
                            'pfMeanQualityScore' : parseFloat(dataSetProperties.result[i].properties.PFMEANQUALITYSCORE),
                            'pfYieldq30Percentage' : parseFloat(dataSetProperties.result[i].properties.PFYIELDQ30PERCENTAGE),
                            'pfReadsSum' : dataSetProperties.result[i].properties.PF_READS_SUM,
                            'rawReadsSum' : dataSetProperties.result[i].properties.RAW_READS_SUM,
                            'rawYieldMbases' : dataSetProperties.result[i].properties.RAW_YIELD_MBASES,
                            'yieldMbases' : dataSetProperties.result[i].properties.YIELD_MBASES
                            }); 
    }
/* 
    statisticsArray = [{"index1": "abc", "percFilteringPass": 0.10, "percRawClustersPerLane" : 20}, {"index1" : "cde", "percFilteringPass": 10.01, "percRawClustersPerLane": 31},
                       {"index1": "yyy", "percFilteringPass": 40.10, "percRawClustersPerLane" : 20}, {"index1" : "asas", "percFilteringPass": 50.01, "percRawClustersPerLane": 32},
                       {"index1": "xxx", "percFilteringPass": 20.10, "percRawClustersPerLane" : 20}, {"index1" : "dffds", "percFilteringPass": 60.01, "percRawClustersPerLane": 32},
                       {"index1": "zzz", "percFilteringPass": 70.10, "percRawClustersPerLane" : 20}, {"index1" : "cfggg", "percFilteringPass": 70.01, "percRawClustersPerLane": 32},
                       {"index1": "z", "percFilteringPass": 99.10, "percRawClustersPerLane" : 20}, {"index1" : "KHJdfsk", "percFilteringPass": 80.01, "percRawClustersPerLane": 32},
                       {"index1": "zppp", "percFilteringPass": 30.10, "percRawClustersPerLane" : 20}, {"index1" : "sda", "percFilteringPass": 90.01, "percRawClustersPerLane": 32}
                       ]
*/
/*
    statisticsArray = [{"index1": "abc", "percFilteringPass": 90, "percRawClustersPerLane" : 20}, {"index1" : "cde", "percFilteringPass": 91, "percRawClustersPerLane": 31},
                       {"index1": "yyy", "percFilteringPass": 80, "percRawClustersPerLane" : 20}, {"index1" : "asas", "percFilteringPass": 92, "percRawClustersPerLane": 32},
                       {"index1": "zppp", "percFilteringPass": 90, "percRawClustersPerLane" : 20}, {"index1" : "sda", "percFilteringPass": 99, "percRawClustersPerLane": 32}
                       ]
*/
    //console.log (statisticsArray)
    //console.log (statisticsArray.length)

    if (! isNaN(statisticsArray[0].percFilteringPass)) {
      plotTable (statisticsArray)
      plotPercFilteringPass (statisticsArray);
      plotReadsSum (statisticsArray, 'rawReadsSum');
      plotPercRawClustersPerLane (statisticsArray)
    }
  }
 
colors = ["#FED976", "#FEB24C", "#FD8D3C", "#FC4E2A", "#E31A1C", "#800026", "#610B5E", "#4C0B5F",
          "#0B0B61", "#0B4C5F", "#0B5F48","#0B5F1E", "#4C5F0B", "#5F480B", "#5F1E0B", "#5F0B22",
           ]

function isNumber(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
}

function plotTable (statisticsArray) {

  var formatThousands = d3.format(",");

  var tableStats = d3.select("body")
    .append("table")
    .style("border-collapse", "collapse")
    .style("border", "1px black solid")
    .attr("class", "tableStats")
    ;

  // create the table header
  var thead = d3.select("table").selectAll("th")
              .data(d3.keys(statisticsArray[0]))
              .enter().append("th")
              .text(function(d){return d})
              .style("padding", "15px")
              .on("mouseover", function(){d3.select(this).style("background-color", "aliceblue")})
              .on("mouseout", function(){d3.select(this).style("background-color", "white")})
              .style("font-size", "16px")
              ;

  // fill the table
  // create rows
  var tr = d3.select("table").selectAll("tr")
           .data(statisticsArray).enter().append("tr")

  // cells
  var td = tr.selectAll("td")
    .data(function(d){return d3.values(d)})
    .enter().append("td")
    .text(function(d) {if (isNumber(d)) {return formatThousands(d)}; return d;})
    .on("mouseover", function(){d3.select(this).style("background-color", "aliceblue")})
    .on("mouseout", function(){d3.select(this).style("background-color", "white")})
    .style("padding", "5px")
    ;
}

function plotPercFilteringPass (statisticsArray) {

  if (statisticsArray.length > 60) {var svgWidth = 7000;}
  else if (statisticsArray.length > 10) {var svgWidth = 4000;}
  else {var svgWidth = 3000;}

  svgWidth = statisticsArray.length * 120
  if (svgWidth < 200) {svgWidth = 300;}


  var barPadding = 1;
  var valuePadding = 0.01;
  var agenda = [100,90,80,70,60,50,40,30,20,10,0]
  var agendaWidth = 100
  var AgendaWidthOffset = 30

  var margin = {top: 20, right: 20, bottom: 40, left: 40},
    svgWidth = svgWidth - margin.left - margin.right,
    svgHeight = 250 - margin.top - margin.bottom;

  var svgFilteredChartAgenda = d3.select("body")
                           .append("svg")
                           .attr("width", agendaWidth )
                           .attr("height", svgHeight + margin.top + margin.bottom)
                           ;  

 var filteredChartAgenda = svgFilteredChartAgenda.selectAll("percFilteringPassChartAgenda")
                                      .data(agenda)
                                      .enter()
                                      .append("rect")
                                      .attr("rx", 3)
                                      .attr("y", function(d, i) { return i * (svgHeight / agenda.length) ;})
                                      .attr("x", function(d) { return 0; })
                                      .attr("width", function (d) { return agendaWidth - AgendaWidthOffset })
                                      .attr("height", function (d) { return  svgHeight / agenda.length - barPadding;})
                                      .attr("fill", function (d) { return "hsla("+ Math.round(d)*1.2 +", 40%, 30%, 1)"});
  
  svgFilteredChartAgenda.selectAll("agendaText")
   		  .data(agenda)
   		  .enter()
   		  .append("text")
   		  .text(function(d) { return d + " %"; })
                  .attr("fill", function(d) { return "white";})
   		  .attr("x", function(d) { return (agendaWidth - AgendaWidthOffset)/2 ; })
   		  .attr("y", function(d, i) { return i *  (svgHeight / agenda.length) +  (svgHeight / agenda.length - barPadding) / 2 + 3;}) 
   		  .attr("font-family", "sans-serif")
	          .attr("font-size", "10px")
	          .attr("text-anchor", "middle")
	          ;
  
  var svgFilteredChart = d3.select("body")
                           .append("svg")
			   .attr("width", svgWidth + margin.left + margin.right)
    	    		   .attr("height", svgHeight + margin.top + margin.bottom)
                           .append("g")
                           .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                           ;

  svgFilteredChart.append('text')
                  .text("% passes Illumina Filtering (PF)")
                  .attr("transform", "translate(" + (svgWidth/2) + "," + (svgHeight - 200) + ")")
                  .attr("font-family", "sans-serif")
                  .attr("font-size", "14px")
                  .attr("text-anchor", "middle")
                  ;

  var x = d3.scale.ordinal()
    .rangeRoundBands([0, svgWidth], valuePadding);
    //.rangeRoundBands([0, svgWidth], .001);

  var y = d3.scale.linear()
    .range([svgHeight, 0]);
 
  var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    //.tickPadding("padding", function () {return 100});
    //.tickPadding(25);

  var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");
    //.tickFormat(formatPercent);
 
  //x.domain(statisticsArray.map(function(d) { return d.externalSampleName+":  "+d.index1;} ));
  x.domain(statisticsArray.map(function(d) { if (d.externalSampleName == undefined ) {return d.index1}; return d.externalSampleName; }));
  //y.domain([0, d3.max(statisticsArray, function(d) { return d.percFilteringPass; })]);
  y.domain([0, 100]);

  svgFilteredChart.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + svgHeight + ")")
      .call(xAxis);

  var filteredChart = svgFilteredChart.selectAll("percFilteringPassChart")
                                      .data(statisticsArray)
                                      .enter()
                                      .append("rect")
                                      .attr("rx", 3)
                                      .attr ("x", function (d) {return x(d.externalSampleName+d.index1);})
                                      .attr ("width", x.rangeBand())
                                      .attr ("y", function (d,i) {return y(d.percFilteringPass);})
                                      .attr("height", function (d,i) {return svgHeight - y(d.percFilteringPass);})
                                      .attr("fill", function (d) { return "hsla("+ Math.round(d.percFilteringPass)*1.2 +", 40%, 30%, 1)"});

  svgFilteredChart.selectAll(".axis text")  // select all the text elements for the xaxis
    .data(statisticsArray)
    .attr ("y", function(d, i) {if (i%2 == 0) {return 8} return 22}); // if index is even the put the text up, else further down

    //.attr("transform", function(d) {
    // return "translate(" + this.getBBox().height*-2 + "," + this.getBBox().height + ")rotate(-45)";
  //});
    

  svgFilteredChart.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .append("text")
      .attr("transform", "rotate(0)")
      .attr("x", 16)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("%");


  svgFilteredChart.selectAll("svgFilteredChartText")
     .data(statisticsArray)
     .enter()
     .append("text")
     .text(function(d) { return d.percFilteringPass + " %"; })
     .attr("x", function(d, i) { return i * 1/(1+valuePadding)*(svgWidth / statisticsArray.length) + ((svgWidth /statisticsArray.length ) /2)  -15; })
     .attr("y", function(d) {
                   if (d.percFilteringPass < 40) { return svgHeight - d.percFilteringPass - margin.top - margin.bottom; }
                   return (svgHeight - d.percFilteringPass  - margin.bottom) ;
                  })
     .attr("font-family", "sans-serif")
     .attr("font-size", "12px")
     .attr("fill", function(d) { if (d.percFilteringPass < 60) { return "black";}
                             return "white";})
}


function plotReadsSum (statisticsArray, field){

  svgWidth = statisticsArray.length * 120
  if (svgWidth < 200) {svgWidth = 300;}

  var formatThousands = d3.format(",");
  var colorRange = d3.scale.ordinal()
      .range(colors);


 
  var margin = {top: 40, right: 20, bottom: 30, left: 40},
    svgWidth = svgWidth - margin.left - margin.right,
    svgHeight = 250 - margin.top - margin.bottom;

  var barPadding = 1;
  var valuePadding = 0.01;

  var svgReadsSum = d3.select("body")
                           .append("svg")
                           .attr("width", svgWidth + margin.left + margin.right)
                           .attr("height", svgHeight + margin.top + margin.bottom)
                           .append("g")
                           .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                           ;

  var rawReadsSum = calculateSum(statisticsArray, field)

  svgReadsSum.append('text')
                  .text("Number of unfiltered Reads " +  formatThousands(rawReadsSum))
                  .attr("transform", "translate(" + (svgWidth/2) + "," + (svgHeight - 200) + ")")
                  .attr("font-family", "sans-serif")
                  .attr("font-size", "14px")
                  .attr("text-anchor", "middle")
                  ;


  var x = d3.scale.ordinal()
    .rangeRoundBands([0, svgWidth], valuePadding);

  var y = d3.scale.linear()
    .range([svgHeight, 0]);
 
  var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

  var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");
 
  x.domain(statisticsArray.map(function(d) { if (d.externalSampleName == undefined ) {return d.index1}; return d.externalSampleName; }));
  y.domain([0, d3.max(statisticsArray, function(d) { return d.rawReadsSum - 20; })]);

  svgReadsSum.append("g")
      .attr("class", "axis")
      .attr("transform", "translate(0," + svgHeight + ")")
      .call(xAxis);

  var ReadsSum = svgReadsSum.selectAll("ReadsSum")
                                      .data(statisticsArray)
                                      .enter()
                                      .append("rect")
                                      .attr("rx", 3)
                                      .attr ("x", function (d) {return x(d.externalSampleName+d.index1);})
                                      .attr ("width", x.rangeBand())
                                      .attr ("y", function (d,i) {return y(d.rawReadsSum) ;})
                                      .attr("height", function (d,i) {return svgHeight - y(d.rawReadsSum);})
                                      //  .attr("fill", function (d) { return "hsla("+ Math.round(d.rawReadsSum)*1.2 +", 40%, 30%, 1)"});
                                      .attr("fill", function(d) { return colorRange(d.rawReadsSum); })
                                      ;

  svgReadsSum.selectAll("svgReadsSumText")
     .data(statisticsArray)
     .enter()
     .append("text")
     .text(function(d) { return formatThousands(d.rawReadsSum); })
     .attr("x", function(d, i) { return i * 1/(1+valuePadding)*(svgWidth / statisticsArray.length) + ((svgWidth /statisticsArray.length ) /2) - 20; })
     .attr("y", function(d) {
                   return (svgHeight - margin.top - margin.bottom + 20) ;
                  })
     .attr("font-family", "sans-serif")
     .attr("font-size", "10px")
     .attr("fill", function(d) { if (d.rawReadsSum < 30000000) { return "black";}
                             return "black";})

     ;

}

function calculateSum(statisticsArray, field) {
  /*console.log(field)
  var obj = JSON.parse(field);
  console.log(obj);
*/
  var sum = 0;
  for (var i = 0; i < statisticsArray.length; i++) {
    sum = sum + parseInt(statisticsArray[i].rawReadsSum);
  }
  //console.log(sum);
  return sum;

}






function plotPercRawClustersPerLane (percRawClustersPerLaneArray) {

  var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

  var colorRange = d3.scale.ordinal()
      .range(colors)

  var margin = {top: 60, right: 20, bottom: 40, left: 40},
    width = 500 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;
  
  var  radius = Math.min(width, height) / 2;

  var arc = d3.svg.arc()
      .outerRadius(radius - 50)
      .innerRadius(radius - 90);

  var pie = d3.layout.pie()
      .sort(null)
      .value(function(d) { return d.percRawClustersPerLane; });

  var svgPercRawClustersPerLaneChart = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2+ ")");

  percRawClustersPerLaneArray.forEach(function(d) {
      d.percRawClustersPerLane = +d.percRawClustersPerLane;
    });

  var g = svgPercRawClustersPerLaneChart.selectAll(".arc")
      .data(pie(percRawClustersPerLaneArray))
      .enter().append("g")
      .attr("class", "arc");

  g.append("path")
      .attr("d", arc)
      .style("fill", function(d) { return colorRange(d.data.index1); });

  g.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .attr("font-family", "sans-serif")
      .attr("font-size", "10px")
      .attr("text-anchor", "middle")
      .text(function (d) {
       var perc = d.data.percRawClustersPerLane + " %";
       if (d.data.externalSampleName == undefined || d.data.externalSampleName.length > 10) {return d.data.index1 + "  " + perc}
               return d.data.externalSampleName + "  " + perc })
      //.on("mouseover", function(){d3.select(this).attr("font-size", "20px")})
      //.on("mouseout", function(){d3.select(this).style("", "white")})
      .on("mouseover", function(d) {      
            div.transition()        
                .duration(200)      
                .style("opacity", .9);      
            div.style("width", Math.max(d.data.externalSampleName.length, d.data.index1.length) * 8 + "px")
            div.html(d.data.externalSampleName + "<br/>" + d.data.index1 + "<br/>" + d.data.percRawClustersPerLane + " %")  
                .style("left", (d3.event.pageX) + "px")     
                .style("top", (d3.event.pageY - 42) + "px");    
            })                  
        .on("mouseout", function(d) {       
            div.transition()        
                .duration(500)      
                .style("opacity", 0);   
        });


  svgPercRawClustersPerLaneChart.append('text')
                   .text("Raw Clusters per Index in %")
                   .attr("fill", "black")
                   .attr("transform", "translate(" + "0" + "," + (height -220) + ")")
                   .attr("font-family", "sans-serif")
                   .attr("font-size", "14px")
                   .attr("text-anchor", "middle")
                   ;

}

  </script>
  </body>
</html>

