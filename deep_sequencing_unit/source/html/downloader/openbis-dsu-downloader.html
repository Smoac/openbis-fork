<html>
<head>
  <title>Quantitative Genomics Facility</title>
  <link type="text/css" rel="stylesheet" href="body-style.css" />
  <link type="text/css" rel="stylesheet" href="button.css" />
  <link type="text/css" rel="stylesheet" href="tree.css" />
  <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="d3.layout.js"></script>
  <script type="text/javascript" src="d3.time.js"></script>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="openbis.js"></script>
  <script type="text/javascript" src="openbis-dsu.js"></script>
  <!-- To speed development, cache the requests -->
  <!-- <script type="text/javascript" src="openbis-request-cache.js"></script> -->
  <script>

dsu = new openbis_dsu('https://openbis-dsu.ethz.ch/openbis/openbis', 'https://openbis-dsu.ethz.ch/datastore_server');

//After logout the URL redirected to
var logouturl = "https://openbis-dsu.ethz.ch/openbis/downloader/openbis-dsu-downloader.html";

// A helper function for drawing the lines between nodes
var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x] });	

// The tree visualization
var vis;

// The node inspectors
var inspectors;

var inspectorsWidth = 500;

// The root of the tree
var root = { code : "QGF", label: "QGF", children : [], type: 'ROOT' };

// The inspected elements
var inspected = [];

// A date formatter for grouping samples by registration year / month
var yearmonthformat = d3.time.format("%Y-%m");

///
/// FUNCTIONS FOR PUTTING DATA INTO THE TREE
///

function initTree(){
	 dsu.retrieveSequencingSamples(function(data){
		 addSamplesToTree(data.result);
		 showSpaces();
		 updateDiagram(500);
	 });
}

function addSamplesToTree(samples)
{
	if (samples == null){
		return;
	}
	
	// Create sample nodes 
	samples = samples.map(function(sample) {
		return {
			code : sample.permId,
			label: sample.properties["EXTERNAL_SAMPLE_NAME"] + " [" +   sample.code + "]",
			bis: sample,
			type: 'SAMPLE' 
    }
	});
	
	samples.sort(function(sample1, sample2){
		if(sample1.bis.code.toLowerCase() == sample2.bis.code.toLowerCase()) return 0;
		return (sample1.bis.code.toLowerCase() < sample2.bis.code.toLowerCase()) ? 1: -1;
	});
	
	// Create sample group nodes (group by registration date) 
	var sampleGroupsMap = [];
	var sampleGroups = [];
	
	samples.forEach(function(sample) {
		var date = yearmonthformat(new Date(sample.bis.registrationDetails.registrationDate));
		var sampleGroup = sampleGroupsMap[date];
		
		if (undefined === sampleGroup) {
			sampleGroup = {
					code: date,
					label: date,
					samples: [],
					type: 'SAMPLE_GROUP'
			};
			sampleGroupsMap[date] = sampleGroup;
			sampleGroups.push(sampleGroup);
		}
		sampleGroup.samples.push(sample);
	});

	// Sort sample groups from newest to oldest 
	sampleGroups.sort(function(group1, group2) {
		    if (group1.code == group2.code) return 0;
		    return (group1.code < group2.code) ? 1 : -1;
  });
	
	// Create space nodes
	var isFirstSampleGroup = true;
	sampleGroups.forEach(function(sampleGroup){
		var spacesMap = [];
		var spaces = [];
		
    sampleGroup.samples.forEach(function(sample){
	    	var spaceCode = sample.bis.spaceCode;
    	  var space = spacesMap[spaceCode];
    	  
    	  if(undefined == space){
    	     space = {
    	    		  code: sampleGroup.code + "#" + spaceCode,
    	    		  label: spaceCode,
    	    		  _children: [],
    	    		  type: 'SPACE'
    	     }
    	     spacesMap[spaceCode] = space;
    	     spaces.push(space);
    	  }
    	  space._children.push(sample);
    });
    
    if(spaces.length > 1){
    	sampleGroup._children = spaces;
    }else{
      sampleGroup._children = sampleGroup.samples;
    }
    
    if(isFirstSampleGroup){
    	openAllForNode(sampleGroup);
    	isFirstSampleGroup = false;
    }
	});
	
	if (samples.length > 0){
		root.children = sampleGroups;
	}
		
}

function getAppHeight(){
	return Math.max($(window).height() - 50, getVisibleLeafsCountForNode(root) * 30);
}

function getAppWidth(){
	return $(window).width();
}

function closeAll(){
	  root.children.forEach(function(sampleGroup){
		  closeAllForNode(sampleGroup);
	  });
	  updateDiagram(500);
}

function closeAllForNode(node){
	  closeChildren(node);
	  getChildren(node).forEach(function(child){
	    closeAllForNode(child);
	  });
}

function openAllForNode(node){
	openChildren(node);
	getChildren(node).forEach(function(child){
		openAllForNode(child);
	});
}

function getVisibleLeafsCountForNode(node){
	if(node.children){
			var count = 0;
			node.children.forEach(function(child){
				count += getVisibleLeafsCountForNode(child);
			});
			return count;
	}else{
		return 1;
	}
}

function showSpaces()
{	
	// Don't show anything yet, just initialize the visualization
	createVis();
}


var didCreateVis = false;

/**
 * Create the DOM elements to store the visualization (tree + inspectors)
 */
function createVis()
{	
	if (didCreateVis) return;
	
	// Create a div to house the tree visualization and the inspectors
	visgroup = d3.select("#main").append("div");

	// An svg element for the tree visualization
	vis = visgroup.append("svg:svg")
	  .attr("id","mainVis")
  	.append("svg:g")
		.attr("transform", "translate(40, 0)");

	  var legend = vis.append("svg:g")
	  .attr("class","legend")
	  .attr("transform", "translate(-30, 0)");
	  
	  var legendSeq = legend.append("svg:g").attr("class","sequenced").attr("transform","translate(0, 20)");
	  legendSeq.append("svg:circle").attr("r", 5.5);
	  legendSeq.append("svg:text").text("Sequenced").attr("dx", 10).attr("dy",4);

	  var legendNotSeq = legend.append("svg:g").attr("class","notsequenced").attr("transform","translate(0, 40)");
	    legendNotSeq.append("svg:circle").attr("r", 5.5);
	    legendNotSeq.append("svg:text").text("Not Sequenced").attr("dx", 10).attr("dy",4);
	  
	// An element for the inspectors.
	inspectors = visgroup.append("span")
		.style("width", + inspectorsWidth + "px")
		.style("position", "relative")
		.style("overflow", "auto")
		.style("float", "right")
	  .style("top", "20px");

	didCreateVis = true;
}


/**
 * Draw / update the tree
 */
function updateDiagram(duration)
{	

	// Adjust a size of the vis 
	d3.select("#mainVis")
	  .attr("width", getAppWidth() - inspectorsWidth - 50)
    .attr("height", getAppHeight())
	
	// Adjust a size of the tree 
  tree = d3.layout.tree().size([getAppHeight(), getAppWidth() - inspectorsWidth - 500])	
	
	
	// Update the root and compute the new layout 
	var nodes = tree.nodes(root);

	// Draw / update the links	
	var link = vis.selectAll("path.link").data(tree.links(nodes), function(d) { return d.code });
	
	link.enter().append("svg:path")
			.attr("class", "link")
			.attr("d", function(d) {
				var y0 = (null != d.source.y0) ? d.source.y0 : d.source.y; 
				var x0 = (null != d.source.x0) ? d.source.x0 : d.source.x;
				var o = {x: x0, y: y0};
				return diagonal({source: o, target: o});
			})
		.transition()
			.duration(duration)
			.attr("d", diagonal);
		
	link.transition()
		.duration(duration)
		.attr("d", diagonal);
		
	link.exit().transition()
		.duration(duration)
		.attr("d", function(d) {
				var y0 = (null != d.source.y0) ? d.source.y0 : d.source.y; 
				var x0 = (null != d.source.x0) ? d.source.x0 : d.source.x;
				var o = {x: x0, y: y0};
				return diagonal({source: o, target: o});
			})
		.remove();

	// Draw / update the nodes
	var node = vis.selectAll("g.node").data(nodes, function(d) { return d.code });
	
	var nodeEnter = 
		node.enter().append("svg:g")
			.attr("class", classForNode)
			.attr("transform", translateSrc)
			.on("click", toggle_open);

	nodeEnter.append("svg:circle")
		.attr("r", 5.5);

	nodeEnter.append("svg:text")
		.attr("dx", function(d) { return hasChildren(d) ? -8 : 8 })
		.attr("dy", 3)
		.attr("text-anchor", function(d) { return getTextAnchorType(d) })
		.text(function(d) { return d.label });

	nodeEnter
		.transition()
			.duration(duration)
			.attr("transform", translateDst);
		
	
	// Transition nodes to their new position.
	node.transition()
		.duration(duration)
		.attr("class", classForNode)
		.attr("transform", translateDst);

	// Move the text elements to the appropriate position
	node.selectAll("text").transition()
		.duration(duration)
		.attr("dx", function(d) { return hasChildren(d) ? -8 : 8 })
		.attr("text-anchor", function(d) { return getTextAnchorType(d) });
		
	node.exit().transition()
		.duration(duration)
		.attr("transform", translateSrc)
		.remove();
}

function classForNode(d) { 
	// Use whether the node has open children or not to compute the class
	var cssClass = "node " + d.type;
	if (d.inspected) cssClass = cssClass + " inspected";
	if(d.flowlanesLoaded){
		if (d.flowlanes && d.flowlanes.length > 0) {
	          cssClass = cssClass + " sequenced";
	  } else {
		  cssClass = cssClass + " notsequenced";
		}
	}
	return cssClass;
}

function translateSrc(d)
{
	var translate;
	if (d.parent != undefined) {
		var y0 = (null != d.parent.y0) ? d.parent.y0 : d.parent.y;
		var x0 = (null != d.parent.x0) ? d.parent.x0 : d.parent.x;
		translate = "translate(" + y0 + "," + x0 + ")";
	} else {
		translate = "translate(" + 0 + "," + 0 + ")";
	}
	
	return translate;
}

function translateDst(d)
{
	d.x0 = d.x;
	d.y0 = d.y;
	var translate =  "translate(" + d.y + "," + d.x + ")";
	
	return translate;
}

function getChildren(d){
	if(d.children != null){
		return d.children;
	}else if(d._children != null){
		return d._children;
	}else{
		return [];
	}
}

function hasChildren(d)
{
	return d.children != null || d._children != null;
}

function hasChildrenOpen(d){
	return d.children != null;
}

function hasChildrenClosed(d){
	return d._children != null;
}

function closeChildren(d){
	  if(hasChildrenOpen(d)){
	    d._children = d.children;
	    d.children = null;
	  }
}

function openChildren(d){
	  if(hasChildrenClosed(d)){
		    d.children = d._children;
		    d._children = null;
    
		    var hasSampleChildren = d.children && d.children[0].type == 'SAMPLE';
		    
	      if(hasSampleChildren && !d.flowlanesLoaded){
		    	 // Get the flow lanes for each sequencing sample 
		    	  var deferrer = 
		    	    new actionDeferrer(
		    	        function() { d.flowlanesLoaded = true; updateDiagram(500) }, 
		    	        d.children.map(function(samp) { return samp.bis.code; }));
		    	        
		    	  d.children.forEach(function(sample) {
		    	    dsu.retrieveFlowLanesForSequencingSample(sample, function(data) {
		    	      if (data && data.result) sample.flowlanes = data.result.map(function(flowlane) { return { bis : flowlane }});
		    	      sample.flowlanesLoaded = true;
		    	      deferrer.dependencyCompleted(sample.bis.code);
		    	    });
		    	  });
			  }
    }
}
	  
function getTextAnchorType(d){
	return d.type == 'SAMPLE' ? 'start' : 'end'; 	
}

// Toggle children on click.
function toggle_open(d) {
	if (!hasChildren(d)) {
		d.svgNode = this;
		return toggle_inspected.call(this, d);
	}
	
  if (hasChildrenOpen(d)) {
	  closeChildren(d);
  } else {
	  openChildren(d);
  }
  updateDiagram(500);
}

/**
 * Draw / update node inspectors
 */
function updateInspectors(duration)
{	
		// Draw / update the inspectors	
	var inspector = inspectors.selectAll("div.inspector").data(inspected, function (d) { return d.code });
	var box = inspector.enter().append("div")
		.attr("class", "inspector")
		.text(function(d) { return d.label });
		
	box.append("span")
		.attr("class", "close")
		.on("click", toggle_inspected)
		.text("x");
		
	var propsTable = box.append("table").attr("class", "properties");
	propsTable.selectAll("tr").data(function(d) { return props_to_pairs(d.bis.properties) })
		.enter()
			.append("tr")
			.selectAll("td").data(function(d) { return d }).enter()
				.append("td")
				.attr("class", "property")
				.style("opacity", "0")
				.text(function(d) { return d })
			.transition()
				.style("opacity", "1");
				
	var downloadTable = inspector.selectAll("table.downloads").data(function(d) { return [d] });
	
	downloadTable
		.enter()
			.append("table")
				.attr("width", "100%")
				.attr("class", "downloads")
				.style("color", "steelblue");
			
	// Add a caption, but make sure there is just one (this does not work with select())
	downloadTable.selectAll("caption")
			.data(downloadTableCaption)
		.enter()
			.append("caption").text(function(d) { return d; });
			
	// We just want to see non-directories here
	var downloadTableRow = downloadTable.selectAll("tr").data(filesForSequencingSample, function(d) { return d.pathInDataSet });
	downloadTableRow
		.enter()
			.append("tr")
				.append("td")
				.style("text-align", "left")
				.on("click", downloadTableFile)
				.text(function(d) { return d.label; });
	downloadTableRow.sort()
	downloadTableRow
		.exit()
			.transition()
				.duration(duration)
				.style("opacity", "0")
				.remove();
	
	inspector.exit().transition()
		.duration(duration)
		.style("opacity", "0")
		.remove();
}

// Toggle children on click.
function toggle_inspected(d) {
	if (d.inspected) {
		var index = inspected.indexOf(d) 
		if (index > -1)	inspected.splice(index, 1);
		d.inspected = false;
		d3.select(d.svgNode).attr("class", classForNode(d))
	} else {
		d.inspected = true;
		inspected.push(d);
		d3.select(d.svgNode).attr("class", classForNode(d))
		retrieveFilesForSequencingSample(d);
	}
  updateInspectors(500);
}

function retrieveFilesForSequencingSample(sequencing)
{
	// No point getting files for a sample that hasn't been sequenced
	if (!hasSampleBeenSequenced(sequencing)) return;
	
	sequencing.loadingFiles = true;
	
	dsu.retrieveDataSetsForSequencingSample(sequencing, function(data) {
			if (!data.result) return;

			sequencing.datasets = data.result.map(function(bisds) { return {bis : bisds} });
			sequencing.files = [];
						
			// Get all the files and update the inspectors once all the data is avilable
			var deferrer = 
				new actionDeferrer(
					function() {
					   sequencing.files.sort(function(file1, file2){
						   if(file1.label.toLowerCase() == file2.label.toLowerCase()) return 0;
						   return (file1.label.toLowerCase() > file2.label.toLowerCase()) ? 1 : -1;
					   });
						 sequencing.loadingFiles = false; 
						 updateInspectors(500) 
				  }, 
					sequencing.datasets.map(function(ds) { return ds.bis.code; }));
				
			sequencing.datasets.forEach(function(ds) { 
				dsu.server.listFilesForDataSet(ds.bis.code, "/", true, function(data) {					
					if (!data.result) { 
						deferrer.dependencyCompleted(ds.bis.code);
						return;
					}
					data.result.forEach(function (file) {
						file.dataset = ds;
						file.label = file.pathInListing.split("/").pop();
					});
					sequencing.files = sequencing.files.concat(data.result);
					deferrer.dependencyCompleted(ds.bis.code);
				})
			});
	});
}

/**
 * Convert properties to pairs
 */
function props_to_pairs(d)
{
	var pairs = [];
	for (var prop in d) {
		var pair = [prop, d[prop]];
		pairs.push(pair);
	}
	pairs.sort(function(a, b) { 
		if (a[0] == b[0]) return 0;
		// Sort in reverse lexicographical
		return (a[0] < b[0]) ? -1 : 1;
	});
	return pairs;
}


function hasSampleBeenSequenced(d)
{	
	return (d.flowlanes && d.flowlanes.length > 0);
}

function downloadTableCaption(d)
{	
	return hasSampleBeenSequenced(d) ? ["Files"] : ["Not Yet Sequenced"];
}

function downloadTableFile(d)
{
	// If there is no dataset, this is just a marker for loading
	if (!d.dataset) return;
	
	var action = function(data) { 
		try {
			document.location.href = data.result
		} catch (err) {
			// just ignore errors		
		} 
	};
	dsu.server.getDownloadUrlForFileForDataSet(d.dataset.bis.code, d.pathInDataSet, action);
}

function filesForSequencingSample(d)
{
	if (d.loadingFiles) return [{ label : "Loading..." }];
	return (d.files) ? d.files.filter(function(file) { return !file.isDirectory }) : [];
}

function enterApp(data)
{
	if(data.result == null){
		alert("Login or password incorrect");
		$("#username").focus();
		return;
	}
	
	$("#login-form-div").hide();
	$("#main").show();
	
	initTree();
	
	$('#openbis-logo').height(30);
}


$(document).ready(function() {
	$('#main').hide()
	
	$('#logout-button').click(function() { 
           dsu.server.logout(function(data) {$(location).attr('href',logouturl)});
         });
	
	$('#login-form').submit(function() {
		 dsu.server.login( $.trim($('#username').val()), $.trim($('#password').val()), function(data) { enterApp(data) })
	});
	
	dsu.server.ifRestoredSessionActive(function(data) { enterApp(data) });

       // Make the ENTER key the default button
       $("login-form input").keypress(function (e) {
          if ((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
              $('button[type=submit].default').click();
              return false;
          } else {
              return true;
          }
       });
});

// set the focus 
function onPageLoad(){
          if(username.value.length==0) {
            $("#username").focus();
          }
          else {
            $("#login-button").focus();
          }
}


 </script>
</head>
<body onload="onPageLoad()">
<img id="openbis-logo" src="images/openBIS_Logo.svg" alt="openBIS" style="position: absolute; right: 10px; height: 100px;"/>
<div id="login-form-div">
<h1>openBIS Quantitative Genomics Facility</h1>
<form id="login-form" action="javascript:">
<input id="username" type="text" required="required"> <input id="password" type="password" required="required"> <button class="login-button" id="login-button" type="submit">Login</button>
<br>
<br>
<a href="https://crowd-bsse.ethz.ch/crowd/console/forgottenlogindetails!default.action" id="resetpassword" class="resetpassword">Reset password</a>
</form>
</div>

<div id="main">
<div id="button-group">
	<button id="logout-button">Logout</button>
	<button id="close-all-button" onclick="closeAll();">Close All</button>
</div>
</div>
</body>
</html>
