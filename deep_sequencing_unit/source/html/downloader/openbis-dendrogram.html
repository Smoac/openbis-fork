<html>
<head>
  <title>openBIS DSU Downloader</title>
  <link type="text/css" rel="stylesheet" href="body-style.css" />
  <link type="text/css" rel="stylesheet" href="button.css" />
  <link type="text/css" rel="stylesheet" href="tree.css" />
  <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="d3.layout.js"></script>
  <script type="text/javascript" src="d3.time.js"></script>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="openbis.js"></script>
  <script type="text/javascript" src="openbis-dsu.js"></script>
  <!-- To speed development, cache the requests -->
  <script type="text/javascript" src="openbis-request-cache.js"></script>
  <script>

dsu = new openbis_dsu('https://openbis-dsu.ethz.ch/openbis/openbis', 'https://openbis-dsu.ethz.ch/datastore_server');

var w = 840, h = 2400;
// N.b. Height and width are swapped in the tree
var tree = d3.layout.tree().size([h, w - 340]);

// A helper function for drawing the lines between nodes
var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x] });	

// The tree visualization
var vis;

// The node inspectors
var inspectors;

// The root of the tree
var root = { code : "DSU", children : [] };

// The inspected elements
var inspected = [];

// A date formatter for grouping samples by registration year / month
var yearmonthformat = d3.time.format("%Y-%m");

///
/// FUNCTIONS FOR PUTTING DATA INTO THE TREE
///

/*!
 * Add the projects to the tree and trigger a request for experiments
 */
function addProjectsToTree(bisprojs)
{
	if (null == bisprojs) return;
	
	dsu.projects = 
		bisprojs
			.filter(function(project) { return project.code == 'BEISEL' })
			.map(function(project) { return { code : project.code, bis : project} });	
	dsu.projects.forEach(function(project) { 
		var action = function(data) {
			addSequencingSamplesToProject(project, data.result);
			showSequencingSamples();
		}
		dsu.retrieveSequencingSamplesForProject(project, action) 
	});
}

/*!
 * Add the sequencing samples to the project
 */
function addSequencingSamplesToProject(project, bissamps)
{
	if (null == bissamps) return;
	
	samples = bissamps.map(function(samp) { return { code : samp.properties["EXTERNAL_SAMPLE_NAME"] + " [" +   samp.code + "]", externalName: samp.properties["EXTERNAL_SAMPLE_NAME"], project : project, bis : samp } });
	
	// Group the samples by year/month
	var yearmonthSamplesMap = {};
	samples.forEach(function(samp) {
		var date = new Date(samp.bis.registrationDetails.registrationDate);
		var yearmonth = yearmonthformat(date);
		var yearmonthsamples = yearmonthSamplesMap[yearmonth];
		if (undefined === yearmonthsamples) {
			yearmonthsamples = [];
			yearmonthSamplesMap[yearmonth] = yearmonthsamples;
		}
		yearmonthsamples.push(samp);
	});
	
	var groupedSamples = [];
	for (var yearmonth in yearmonthSamplesMap) {
		groupedSamples.push({ code : yearmonth, project : project, children : yearmonthSamplesMap[yearmonth]})
	}
	
	groupedSamples.sort(function(a, b) { 
		if (a.code == b.code) return 0;
		// Sort in reverse lexicographical order		
		return (a.code < b.code) ? 1 : -1;
	});

	if (samples.length > 0)
		project.children = groupedSamples;
		
	// Get the flow lanes for each sequencing sample
	var deferrer = 
		new actionDeferrer(
				function() { updateDiagram(500) }, 
				samples.map(function(samp) { return samp.bis.code; }));
				
	samples.forEach(function(sample) { 
		dsu.retrieveFlowLanesForSequencingSample(sample, function(data) {
			if (data.result) sample.flowlanes = data.result.map(function(flowlane) { return { bis : flowlane }});
			deferrer.dependencyCompleted(sample.bis.code);
		}) 
	});
}


function showProjects()
{	
	// Don't show anything yet, just initialize the visualization
	createVis();
}


function showSequencingSamples()
{
	// Now draw the samples
	updateDiagram(1000);
}

var didCreateVis = false;

/**
 * Create the DOM elements to store the visualization (tree + inspectors)
 */
function createVis()
{
	if (didCreateVis) return;
	
	// Create a div to house the tree visualization and the inspectors
	visgroup = d3.select("#main").append("div");
	visgroup.style("width", "" + (w + 400) + "px")
	
	// An svg element for the tree visualization
	vis = visgroup.append("svg:svg")
		.attr("width", w)
		.attr("height", h)
	.append("svg:g")
		.attr("transform", "translate(40, 0)");
	
	// An element for the inspectors.
	inspectors = visgroup.append("span")
		.style("width", "400px")
		.style("position", "relative")
		.style("overflow", "auto")
		.style("float", "right")
		.style("left", "20px");
		
	didCreateVis = true;
}


/**
 * Draw / update the tree
 */
function updateDiagram(duration)
{	
	// Update the root and compute the new layout
	root.children = dsu.projects;
	var nodes = tree.nodes(root);

	// Draw / update the links	
	var link = vis.selectAll("path.link").data(tree.links(nodes), function(d) { return d.code });
	
	link.enter().append("svg:path")
			.attr("class", "link")
			.attr("d", function(d) {
				var y0 = (null != d.source.y0) ? d.source.y0 : d.source.y; 
				var x0 = (null != d.source.x0) ? d.source.x0 : d.source.x;
				var o = {x: x0, y: y0};
				return diagonal({source: o, target: o});
			})
		.transition()
			.duration(duration)
			.attr("d", diagonal);
		
	link.transition()
		.duration(duration)
		.attr("d", diagonal);
		
	link.exit().transition()
		.duration(duration)
		.attr("d", function(d) {
				var y0 = (null != d.source.y0) ? d.source.y0 : d.source.y; 
				var x0 = (null != d.source.x0) ? d.source.x0 : d.source.x;
				var o = {x: x0, y: y0};
				return diagonal({source: o, target: o});
			})
		.remove();

	// Draw / update the nodes
	var node = vis.selectAll("g.node").data(nodes, function(d) { return d.code });
	
	var nodeEnter = 
		node.enter().append("svg:g")
			.attr("class", classForNode)
			.attr("transform", translateSrc)
			.on("click", toggle_open);

	nodeEnter.append("svg:circle")
		.attr("r", 5.5);

	nodeEnter.append("svg:text")
		.attr("dx", function(d) { return hasChildren(d) ? -8 : 8 })
		.attr("dy", 3)
		.attr("text-anchor", function(d) { return hasChildren(d) ? "end" : "start" })
		.text(function(d) { return d.code });

	nodeEnter
		.transition()
			.duration(duration)
			.attr("transform", translateDst);
		
	
	// Transition nodes to their new position.
	node.transition()
		.duration(duration)
		.attr("class", classForNode)
		.attr("transform", translateDst);

	// Move the text elements to the appropriate position
	node.selectAll("text").transition()
		.duration(duration)
		.attr("dx", function(d) { return hasChildren(d) ? -8 : 8 })
		.attr("text-anchor", function(d) { return hasChildren(d) ? "end" : "start" });
		
	node.exit().transition()
		.duration(duration)
		.attr("transform", translateSrc)
		.remove();
}

function classForNode(d) { 
	// Use whether the node has open children or not to compute the class
	var cssClass = hasChildren(d) ? "node withchildren" : "node leaf";
	if (d.inspected) cssClass = cssClass + " inspected";
	if (d.flowlanes && d.flowlanes.length > 0) cssClass = cssClass + " sequenced";

	return cssClass;
}

function translateSrc(d)
{
	var translate;
	if (d.parent != undefined) {
		var y0 = (null != d.parent.y0) ? d.parent.y0 : d.parent.y;
		var x0 = (null != d.parent.x0) ? d.parent.x0 : d.parent.x;
		translate = "translate(" + y0 + "," + x0 + ")";
	} else {
		translate = "translate(" + 0 + "," + 0 + ")";
	}
	
	return translate;
}

function translateDst(d)
{
	d.x0 = d.x;
	d.y0 = d.y;
	var translate =  "translate(" + d.y + "," + d.x + ")";
	
	return translate;
}

function hasChildren(d)
{
	return d.children != null || d._children != null;
}

function hasOpenChildren(d)
{
	return d.children != null;
}

// Toggle children on click.
function toggle_open(d) {
	if (!hasChildren(d)) {
		d.svgNode = this;
		return toggle_inspected.call(this, d);
	}
	
  if (d.children) {
    d._children = d.children;
    d.children = null;
  } else {
    d.children = d._children;
    d._children = null;
  }
  updateDiagram(500);
}

/**
 * Draw / update node inspectors
 */
function updateInspectors(duration)
{	
		// Draw / update the inspectors	
	var inspector = inspectors.selectAll("div.inspector").data(inspected, function (d) { return d.code });
	var box = inspector.enter().append("div")
		.attr("class", "inspector")
		.text(function(d) { return d.code });
		
	box.append("span")
		.attr("class", "close")
		.on("click", toggle_inspected)
		.text("x");
		
	var table = box.append("table");
	table.selectAll("tr").data(function(d) { return props_to_pairs(d.bis.properties) })
		.enter()
			.append("tr")
			.selectAll("td").data(function(d) { return d }).enter()
				.append("td")
				.attr("class", "property")
				.style("opacity", "0")
				.text(function(d) { return d })
			.transition()
				.style("opacity", "1");
				
	var downloadTable = 
		box.append("table")
			.attr("width", "100%")
			.attr("class", "downloads")
			.style("color", "steelblue");
		downloadTable.append("caption").text("Files");
	var downloadTableRow = downloadTable.append("tr");
	downloadTableRow
		.append("td")
			.style("text-align", "left")
			.text("metadata.tsv");
	downloadTableRow
		.append("td")
			.style("border-right", "0px")
			.style("text-align", "right")
			.text("fastq.gz");
		
	inspector.exit().transition()
		.duration(duration)
		.style("opacity", "0")
		.remove();
}

// Toggle children on click.
function toggle_inspected(d) {
	if (d.inspected) {
		var index = inspected.indexOf(d) 
		if (index > -1)	inspected.splice(index, 1);
		d.inspected = false;
		d3.select(d.svgNode).attr("class", classForNode(d))
	} else {
		d.inspected = true;
		inspected.push(d);
		d3.select(d.svgNode).attr("class", classForNode(d))
		retrieveFilesForSequencingSample(d);
	}
  updateInspectors(500);
}

function retrieveFilesForSequencingSample(sequencing)
{
	// dsu.retrieveFastqGzDataSetsForFlowLane(sequencing, function(data) { 
	// 		sequencing.files = data.result;
	// });
}

/**
 * Convert properties to pairs
 */
function props_to_pairs(d)
{
	var pairs = [];
	for (var prop in d) {
		var pair = [prop, d[prop]];
		pairs.push(pair);
	}
	pairs.sort(function(a, b) { 
		if (a[0] == b[0]) return 0;
		// Sort in reverse lexicographical
		return (a[0] < b[0]) ? -1 : 1;
	});
	return pairs;
}

function enterApp()
{
	$("#login-form-div").hide();
	$("#main").show();
	dsu.server.listProjects(function(data) { 
		addProjectsToTree(data.result); 
		showProjects();
	});
}


$(document).ready(function() {
	$('#main').hide()
	
	$('#logout-button').click(function() { dsu.server.logout(function(data) {}) });
	
	$('#login-form').submit(function() {
		 dsu.server.login( $('#username').val(), $('#password').val(), function(data) { enterApp() })
	});
	
	dsu.server.ifRestoredSessionActive(function(data) { enterApp() });
 });
 
 </script>
</head>
<body>

<div id="login-form-div">
<h1>openBIS DSU</h1>

<form id="login-form" action="javascript:">
<input id="username" type="text"> <input id="password" type="password"> <button id="login-button">Login</button>
</form>
</div>

<div id="main">
<div id="button-group">
	<button id="logout-button">Logout</button>
</div>
</div>

</body>
</html>