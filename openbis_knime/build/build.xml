<project name="openbis_knime" basedir="..">
  <import file="../../build_resources/ant/build-common.xml" />
  <project-classpath name="ecp" classes="${classes}" />
  <property name="mainfolder" value="openbis_knime"/>
	<property name="version" value="0.1.0"/>
  <property name="jar.file.name" value="openbis-knime.jar"/>
  <property name="jar.file" value="${dist}/${jar.file.name}"/>
  <property name="original.dist" value="../${ant.project.name}/dist" />


  <!-- 
  // Cleans distribution directory.
  -->
  <target name="clean" description="Cleans distribution directory.">
    <delete dir="${dist}" failonerror="true" />
    <mkdir dir="${dist}" />
  </target>

  <!-- 
  // Runs tests.
  -->
  <target name="run-tests">
    <antcall target="build-common.run-tests">
       <param name="test.suite" value="tests.xml" />
    </antcall>
  </target>
	        
  <!--
  // Creates build information.
  -->
 <target name="build-info" description="Creates build information.">
    <!--build-info revision="revision.number" version="version.number" clean="clean.flag" />
    <echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo-->
    <echo file="${build.info.file}">abc:123:d</echo>
 </target>

 <!--
 // Creates JAR file.
 -->
 <target name="jar" depends="compile, build-info" description="Creates project jar file.">
   <delete file="${jar.file}" />
   <recursive-jar destfile="${jar.file}">
     <fileset dir="${classes}">
       <include name="**/*.class" />
       <include name="${build.info.filename}" />
     </fileset>
     <fileset dir="${sources}">
       <include name="**/*.xml" />
       <include name="**/*.png" />
     </fileset>
   </recursive-jar>
 </target>
	
    <!-- 
    // Makes a distribution file.
    -->
    <target name="dist" description="Makes a distribution file." depends="clean, jar">

      <!--property name="dist.file.name" value="ch.systemsx.cisd.openbis.knime-${version}.v${version.number}-r${revision.number}.zip" /-->
      <property name="dist.file.name" value="${dist}/ch.systemsx.cisd.openbis.knime-${version}.jar" />

    	<jar destfile="${dist.file.name}" manifest="${original.dist}/META-INF/MANIFEST.MF">
    		<fileset dir="${dist}">
    			<include name="${jar.file.name}"/>
    		</fileset>
    		<fileset dir="${original.dist}">
    			<include name="**/*"/>
    		</fileset>
    		<zipfileset prefix="lib" file="${lib}/openbis-apis/query/openbis-query-api.jar"/>
    		<zipfileset prefix="lib" file="${lib}/cisd-base/cisd-base.jar"/>
        <zipfileset prefix="lib" file="${lib}/commons-codec/commons-codec.jar"/>
        <zipfileset prefix="lib" file="${lib}/commons-httpclient/commons-httpclient.jar"/>
        <zipfileset prefix="lib" file="${lib}/commons-logging/commons-logging.jar"/>
        <zipfileset prefix="lib" file="${lib}/log4j/log4j.jar"/>
        <zipfileset prefix="lib" file="${lib}/spring/spring.jar"/>
        <zipfileset prefix="lib" file="${lib}/spring/third-party/stream-supporting-httpinvoker.jar"/>
    	</jar>
      <delete file="${jar.file}"/>
   </target>

   <!--
   // Task for continuous integration server.
   -->
   <target name="ci" depends="build-common.ci, check-dependencies, dist"
           description="Task for continuous integration server." />
	        
   <!--
   // Compiles the javascript using GWT compiler.
   -->
   <target name="compile-javascript" description="Compiles the javascript using GWT compiler.">
      <property name="application.gwt.path" value="ch.systemsx.cisd.datamover.console.DatamoverConsole" />
      <echo></echo>
      <delete dir="${webapp.dist}" />
      <java classpath="${ecp}:${gwt.dev.lib}:${gwt.user.lib}:${sources}"
            classname="com.google.gwt.dev.GWTCompiler"
            fork="true">
        <jvmarg value="-Xmx512M" />
        <arg value="-out" />
        <arg value="${webapp.dist}" />
        <arg value="${application.gwt.path}" />
      </java>
      <move todir="${webapp.dist}">
         <fileset dir="${webapp.dist}/${application.gwt.path}" />
      </move>
   </target>


</project>