<project name="jhdf5" default="dist" basedir="..">
	<import file="../../build_resources/ant/build-common.xml" />
	<project-classpath name="ecp" classes="${classes}:${lib}/junit4/junit.jar" />

	<property name="mainfolder" value="sis-${ant.project.name}" />
	<property name="distfolder" value="${ant.project.name}" />
	<property name="jar.file" value="${dist}/sis-jhdf5.jar" />
	<property name="dist.file" value="${dist}/sis-jhdf5" />
	<property name="jar.batteries-included.filename"
	          value="sis-jhdf5-batteries_included.jar" />
	<property name="jar.batteries-included.file" value="${dist}/${jar.batteries-included.filename}" />
	<property name="jar.core.file" value="${dist}/sis-jhdf5-core.jar" />
	<property name="jar.tools.file" value="${dist}/sis-jhdf5-tools.jar" />
	<property name="sources.examples" value="sourceExamples/java" />
	<property name="src.zip.file" value="${dist}/sis-jhdf5-src.zip" />
	<property name="examples.src.zip.file" value="${dist}/sis-jhdf5-examples-src.zip" />
	<property name="javadoc.zip.file" value="${dist}/sis-jhdf5-javadoc.zip" />
	<property name="test.jar.file" value="${dist}/sis-jhdf5-test.jar" />
	<property name="lib" value="../libraries" />
	<property name="original.dist" value="../${ant.project.name}/dist" />
	<property name="nativesrc1" value="${lib}/hdf5/native" />
	<property name="nativesrc2" value="${lib}/unix/native" />
	<property name="nativeroot" value="${targets}/ant" />
	<property name="native" value="${nativeroot}/native" />

	<property name="dist.hdf5" value="${dist}/${mainfolder}" />
	<property name="dist.hdf5.lib" value="${dist.hdf5}/lib" />

	<target name="clean">
		<delete dir="${dist}" />
		<delete dir="${targets}/ant" />
	</target>

	<target name="jar-test" depends="clean, compile-tests">
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<copy todir="${native}">
			<fileset dir="${nativesrc1}">
				<include name="**/libjhdf5.so" />
				<include name="**/libjhdf5.jnilib" />
				<include name="**/jhdf5.dll" />
			</fileset>
		</copy>
		<recursive-jar destfile="${test.jar.file}">
			<fileset dir="${classes}">
				<include name="**/*.class" />
				<include name="${build.info.filename}" />
			</fileset>
			<fileset dir="${nativeroot}">
				<include name="native/**/*.so" />
				<include name="native/**/*.jnilib" />
				<include name="native/**/*.dll" />
			</fileset>
			<fileset dir="${sources.test}/test/hdf5lib">
				<include name="*.hdf" />
			</fileset>
			<zipfileset src="${lib}/testng/testng-jdk15.jar" />
			<zipfileset src="${lib}/junit4/junit.jar" />
			<zipfileset src="${lib}/jmock/hamcrest/hamcrest-core.jar" />
			<zipfileset src="${lib}/cisd-base/cisd-base.jar" />
			<zipfileset src="${lib}/cisd-args4j/cisd-args4j.jar" />
			<zipfileset src="${lib}/commons-lang/commons-lang.jar" />
			<zipfileset src="${lib}/commons-io/commons-io.jar" />
			<manifest>
				<attribute name="Main-Class" value="ch.systemsx.cisd.hdf5.HDF5RoundtripTest" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</recursive-jar>
	</target>

	<target name="jar-complete" depends="compile">
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<copy todir="${native}">
			<fileset dir="${nativesrc1}">
				<include name="**/libjhdf5.so" />
				<include name="**/libjhdf5.jnilib" />
				<include name="**/jhdf5.dll" />
			</fileset>
		</copy>
		<recursive-jar destfile="${jar.batteries-included.file}">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
				<include name="**/*.class" />
			</fileset>
			<fileset dir="${nativeroot}">
				<include name="native/**/*.so" />
				<include name="native/**/*.jnilib" />
				<include name="native/**/*.dll" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<exclude name="${build.info.filename}" />
			</zipfileset>
			<zipfileset src="${lib}/cisd-args4j/cisd-args4j.jar">
				<exclude name="${build.info.filename}" />
				<exclude name="**/AbstractBuildAndEnvironmentInfo.class" />
			</zipfileset>
			<zipfileset src="${lib}/commons-lang/commons-lang.jar">
				<exclude name="META-INF/LICENSE.txt" />
				<exclude name="META-INF/NOTICE.txt" />
			</zipfileset>
			<zipfileset src="${lib}/commons-io/commons-io.jar">
				<exclude name="META-INF/LICENSE.txt" />
				<exclude name="META-INF/NOTICE.txt" />
			</zipfileset>
			<manifest>
				<attribute name="Main-Class" value="ch.systemsx.cisd.hdf5.h5ar.HDF5ArchiverMain" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</recursive-jar>
		<recursive-jar destfile="${jar.file}">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
				<include name="**/*.class" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<exclude name="${build.info.filename}" />
				<exclude name="native/**" />
			</zipfileset>
			<zipfileset src="${lib}/cisd-args4j/cisd-args4j.jar">
				<exclude name="${build.info.filename}" />
				<exclude name="**/AbstractBuildAndEnvironmentInfo.class" />
			</zipfileset>
			<zipfileset src="${lib}/commons-lang/commons-lang.jar">
				<exclude name="META-INF/LICENSE.txt" />
				<exclude name="META-INF/NOTICE.txt" />
			</zipfileset>
			<zipfileset src="${lib}/commons-io/commons-io.jar">
				<exclude name="META-INF/LICENSE.txt" />
				<exclude name="META-INF/NOTICE.txt" />
			</zipfileset>
			<manifest>
				<attribute name="Main-Class" value="ch.systemsx.cisd.hdf5.h5ar.HDF5ArchiverMain" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
				<attribute name="Class-Path"
				           value="hdf5-linux-intel.jar hdf5-macosx-intel.jar hdf5-windows-intel.jar" />
			</manifest>
		</recursive-jar>
	</target>

	<target name="examples-src-zip">
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<recursive-jar destfile="${examples.src.zip.file}">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
			</fileset>
			<fileset dir="${sources.examples}">
				<include name="**/*.java" />
			</fileset>
			<manifest>
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</recursive-jar>
	</target>

	<target name="src-zip">
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<recursive-jar destfile="${src.zip.file}">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
			</fileset>
			<fileset dir="${sources}">
				<include name="**/*.java" />
			</fileset>
			<manifest>
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</recursive-jar>
	</target>

	<target name="jar-core" depends="compile">
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<jar destfile="${jar.core.file}">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
				<include name="**/*.class" />
				<exclude name="**/io/*.class" />
				<exclude name="**/h5ar/*.class" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<include name="ch/systemsx/cisd/base/utilities/AbstractBuildAndEnvironmentInfo.class" />
			</zipfileset>
			<manifest>
				<attribute name="Main-Class" value="ch.systemsx.cisd.hdf5.BuildAndEnvironmentInfo" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</jar>
	</target>

	<target name="jar-tools" depends="compile">
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<jar destfile="${jar.tools.file}">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
				<include name="**/io/*.class" />
				<include name="**/h5ar/*.class" />
				<include name="ch/systems/cisd/hdf5/BuildAndEnvironmentInfo*.class" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<include name="ch/systemsx/cisd/base/utilities/AbstractBuildAndEnvironmentInfo.class" />
			</zipfileset>
			<manifest>
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
				<attribute name="Main-Class" value="ch.systemsx.cisd.hdf5.h5ar.HDF5ArchiverMain" />
				<attribute name="Class-Path"
				           value="commons-lang.jar commons-io.jar cisd-base.jar cisd-args4j.jar sis-jhdf5-core.jar hdf5-linux-intel.jar hdf5-macosx-intel.jar hdf5-windows-intel.jar" />
			</manifest>
		</jar>
	</target>

	<target name="jar-all"
	        depends="jar-complete, src-zip, examples-src-zip, jar-core, jar-tools, jar-platforms" />

	<target name="jar-platforms"
	        depends="jar-linux-intel, jar-macosx-intel, jar-windows-intel" />

	<target name="jar-linux-intel" depends="compile">
		<delete dir="${native}" />
		<mkdir dir="${native}" />
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<copy todir="${native}">
			<fileset dir="${nativesrc1}">
				<include name="jhdf5/i386-Linux/libjhdf5.so" />
				<include name="jhdf5/amd64-Linux/libjhdf5.so" />
			</fileset>
			<fileset dir="${nativesrc2}">
				<include name="unix/i386-Linux/libunix.so" />
				<include name="unix/amd64-Linux/libunix.so" />
			</fileset>
		</copy>
		<jar destfile="${dist}/hdf5-linux-intel.jar">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
			</fileset>
			<fileset dir="${nativeroot}">
				<include name="native/**/*.so" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<include name="ch/systemsx/cisd/base/utilities/BuildAndEnvironmentInfo.class" />
			</zipfileset>
			<manifest>
				<attribute name="Main-Class"
				           value="ch.systemsx.cisd.base.utilities.BuildAndEnvironmentInfo" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</jar>
	</target>

	<target name="jar-macosx-intel" depends="compile">
		<delete dir="${native}" />
		<mkdir dir="${native}" />
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<copy todir="${native}">
			<fileset dir="${nativesrc1}">
				<include name="jhdf5/i386-Mac OS X/libjhdf5.jnilib" />
				<include name="jhdf5/x86_64-Mac OS X/libjhdf5.jnilib" />
			</fileset>
			<fileset dir="${nativesrc2}">
				<include name="unix/i386-Mac OS X/libunix.jnilib" />
				<include name="unix/x86_64-Mac OS X/libunix.jnilib" />
			</fileset>
		</copy>
		<jar destfile="${dist}/hdf5-macosx-intel.jar">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
			</fileset>
			<fileset dir="${nativeroot}">
				<include name="native/**/*.jnilib" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<include name="ch/systemsx/cisd/base/utilities/BuildAndEnvironmentInfo.class" />
			</zipfileset>
			<manifest>
				<attribute name="Main-Class"
				           value="ch.systemsx.cisd.base.utilities.BuildAndEnvironmentInfo" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</jar>
	</target>

	<target name="jar-windows-intel" depends="compile">
		<delete dir="${native}" />
		<mkdir dir="${native}" />
		<mkdir dir="${dist.hdf5.lib}" />
		<build-info revision="revision.number" version="version.number" clean="clean.flag" />
		<echo file="${build.info.file}">${version.number}:${revision.number}:${clean.flag}</echo>
		<copy todir="${native}">
			<fileset dir="${nativesrc1}">
				<include name="jhdf5/x86-Windows/jhdf5.dll" />
				<include name="jhdf5/amd64-Windows/jhdf5.dll" />
			</fileset>
		</copy>
		<jar destfile="${dist}/hdf5-windows-intel.jar">
			<fileset dir="${classes}">
				<include name="${build.info.filename}" />
			</fileset>
			<fileset dir="${nativeroot}">
				<include name="native/**/*.dll" />
			</fileset>
			<zipfileset src="${lib}/cisd-base/cisd-base.jar">
				<include name="ch/systemsx/cisd/base/utilities/BuildAndEnvironmentInfo.class" />
			</zipfileset>
			<manifest>
				<attribute name="Main-Class"
				           value="ch.systemsx.cisd.base.utilities.BuildAndEnvironmentInfo" />
				<attribute name="Version" value="${version.number}" />
				<attribute name="Build-Number"
				           value="${version.number} (r${revision.number},${clean.flag})" />
			</manifest>
		</jar>
	</target>

	<target name="doc">
		<delete dir="${targets}/doc" />
		<delete dir="${targets}/source-base" />
		<unzip src="../libraries/cisd-base/cisd-base-src.zip" dest="${targets}/source-base" />
		<javadoc classpath="../base/targets/classes:../libraries/cisd-base/cisd-base.jar:../libraries/commons-lang/commons-lang.jar:../libraries/commons-io/commons-io.jar:../libraries/restrictionchecker/restrictions.jar:../libraries/cisd-args4j/cisd-args4j.jar"
		         destdir="targets/doc"
		         doctitle="JHDF5 14.06"
		         author="false"
		         overview="overview.html"
		         access="public">
			<fileset dir="source/java" defaultexcludes="yes">
				<include name="ch/systemsx/cisd/hdf5/**/*.java" />
				<include name="ncsa/hdf/hdf5lib/exceptions/**/*.java" />
				<exclude name="ch/systemsx/cisd/hdf5/hdf5lib/**/*.java" />
				<exclude name="ch/systemsx/cisd/hdf5/cleanup/**/*.java" />
				<exclude name="ch/systemsx/cisd/hdf5/MatrixUtils.java" />
				<exclude name="ch/systemsx/cisd/hdf5/StringUtils.java" />
				<exclude name="ch/systemsx/cisd/hdf5/ReflectionUtils.java" />
				<exclude name="ch/systemsx/cisd/hdf5/BitSetConversionUtils.java" />
			</fileset>
			<fileset dir="${targets}/source-base" defaultexcludes="yes">
				<include name="ch/systemsx/cisd/base/mdarray/**/*.java" />
			</fileset>
		</javadoc>
		<copy todir="${targets}/doc">
			<fileset dir="${sources.examples}" />
		</copy>
		<copy file="${original.dist}/doc/JHDF5.pdf" todir="${targets}/doc" />
	</target>

	<target name="dist" depends="clean, jar-all, doc">
		<zip destfile="${javadoc.zip.file}" basedir="${targets}" includes="doc/**" />
		<delete dir="${dist}/${mainfolder}" />
		<copy file="${lib}/cisd-args4j/cisd-args4j.jar" todir="${dist}/${distfolder}/lib" />
		<copy file="${lib}/cisd-base/cisd-base.jar" todir="${dist}/${distfolder}/lib" />
		<copy file="${lib}/commons-lang/commons-lang.jar" todir="${dist}/${distfolder}/lib" />
		<copy file="${lib}/commons-io/commons-io.jar" todir="${dist}/${distfolder}/lib" />
		<move file="${jar.batteries-included.file}"
		      todir="${dist}/${distfolder}/lib/batteries_included" />
		<move file="${dist}/hdf5-linux-intel.jar" todir="${dist}/${distfolder}/lib/nativejar" />
		<move file="${dist}/hdf5-macosx-intel.jar" todir="${dist}/${distfolder}/lib/nativejar" />
		<move file="${dist}/hdf5-windows-intel.jar" todir="${dist}/${distfolder}/lib/nativejar" />
		<move todir="${dist}/${distfolder}/lib">
			<fileset dir="${dist}">
				<include name="*.jar" />
			</fileset>
		</move>
		<unzip src="${dist}/${distfolder}/lib/batteries_included/${jar.batteries-included.filename}"
		       dest="${dist}/${distfolder}/lib">
			<patternset>
				<include name="native/**" />
			</patternset>
		</unzip>
		<move file="${src.zip.file}" todir="${dist}/${distfolder}/src" />
		<move file="${javadoc.zip.file}" todir="${dist}/${distfolder}/doc" />
		<move file="${examples.src.zip.file}" todir="${dist}/${distfolder}/doc" />
		<copy todir="${dist}/${distfolder}">
			<fileset dir="${original.dist}" />
		</copy>
		<zip destfile="${dist.file}-${version.number}-r${revision.number}.zip">
			<zipfileset dir="${dist}/${distfolder}" prefix="${mainfolder}" excludes="**/*.sh" />
			<zipfileset dir="${dist}/${distfolder}"
			            prefix="${mainfolder}"
			            includes="**/*.sh"
			            filemode="755" />
		</zip>
		<delete dir="${dist}/${distfolder}" />
	</target>

	<!--
	// Task for continuous integration server.
	-->
	<target name="ci"
	        depends="build-common.ci, check-dependencies"
	        description="Task for continuous integration server." />

</project>
